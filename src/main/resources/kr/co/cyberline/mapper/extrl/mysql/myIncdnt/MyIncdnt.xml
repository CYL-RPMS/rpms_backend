<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MyIncdnt">
    <!--[통신분쟁]2021-11-08 / Kait-72 / by ihpark / 피신청인 본인인증 인증서로 로그인 시 사건이 보이지 않는 오류 - 핸드폰 인증 이후에는 사건 매핑될 수 있게 변경 FIND_IN_SET 구문 추가-->
    <sql id="incCond">
        <where>
            <choose>
                <when test="login_user_ci != null and login_user_ci != ''">
                    AND (
                            (A.CI = #{login_user_ci} OR A.P_CI = #{login_user_ci} OR D_CI = #{login_user_ci} OR P_D_CI = #{login_user_ci})
                            OR FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) = #{cttpc} <if test="ipin != null and ipin != ''"> AND NM = #{user_nm} </if> ),ADA.P_BIZRNO_LIST) > 0
                            OR FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE P_CI = #{login_user_ci} <if test="ipin != null and ipin != ''"> AND NM = #{user_nm} </if>),ADA.P_BIZRNO_LIST) > 0
                        )
                </when>
                <otherwise>
                    AND ((A.CI = 'a' OR A.P_CI = 'a' OR D_CI = 'a' OR P_D_CI = 'a')
                    OR FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) = #{cttpc}),ADA.P_BIZRNO_LIST) > 0 )
                </otherwise>
            </choose>
            <if test="condNm != null and condNm != ''">
                AND A.NM LIKE CONCAT('%',#{condNm},'%')
            </if>
            <if test="condP_nm != null and condP_nm != ''">
                AND A.P_NM LIKE CONCAT('%',#{condP_nm},'%')
            </if>
            <if test="crte_dttm_str != null and crte_dttm_str != '' and crte_dttm_end != null and crte_dttm_end != ''">
                AND DATE_FORMAT(C.CRTE_DTTM, '%Y-%m-%d') BETWEEN #{crte_dttm_str} AND #{crte_dttm_end}
            </if>
            <if test="condReqst_reason != null and condReqst_reason != ''">
                AND A.REQST_REASON LIKE CONCAT('%',#{condReqst_reason},'%')
            </if>
            <if test="condTrubl_mdat_no != null and condTrubl_mdat_no != ''">
                AND A.TRUBL_MDAT_NO LIKE CONCAT('%',#{condTrubl_mdat_no},'%')
            </if>
            <if test="condSttus != null and condSttus != ''">
                AND A.STTUS = #{condSttus}
            </if>
			AND A.TRUBL_MDAT_NO not like ('%분쟁%')
            /*피신청인은 임시저장이 안보이게*/
            AND IF((CASE WHEN A.CI = #{login_user_ci} THEN 'B'
                        WHEN A.D_CI = #{login_user_ci} THEN 'B'
                        WHEN A.P_D_CI = #{login_user_ci} THEN 'P'
                        WHEN A.P_CI = #{login_user_ci} THEN 'P'
                        WHEN FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) =#{cttpc}),ADA.P_BIZRNO_LIST) > 0 THEN 'P'
                        WHEN FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE P_CI = #{login_user_ci}),ADA.P_BIZRNO_LIST) > 0 THEN 'P'
                        END) = 'P', A.STTUS != 'TM000', 1=1)
            AND CASE WHEN A.P_D_CI = #{login_user_ci} THEN <![CDATA[A.STTUS <> 'TM001']]>
            WHEN A.P_CI = #{login_user_ci} THEN <![CDATA[A.STTUS <> 'TM001']]>
            WHEN FIND_IN_SET(A.BIZRNO, (SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) = #{cttpc})) > 0  THEN <![CDATA[A.STTUS <> 'TM001']]>
            ELSE 1 = 1
			/* 통신분쟁 요청으로 인한 특정사건 나의사건조회에서 안나오도록 수정*/
			AND A.TRUBL_MDAT_NO NOT IN ('TDRC_DM_20230117_0003','TDRC_DM_20230117_0004')
            END

        </where>
    </sql>
    <!--[통신분쟁]2022-01-04 / Kait-81 / by ihpark / 나의사건조회 cond_trget오류 수정 피신청인쪽 문제로 롤백-->
    <!--[통신분쟁]2021-08-30 / Kait-42,Kait-69 / by ihpark / 파일 이력관리 및 7일 이내 등록시 new 표시-->
    <!--[통신분쟁]2021-07-30 / Kait-49 / by ihpark / 신청인/피신청인 구분에 따른 나의사건조회 order by 변경 및 리스트 변경-->
    <select id="list" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.list : 나의사건 조회 목록 조회 */
        <include refid="CylCmm.prefixPagination"/>
        SELECT A.TRUBL_MDAT_NO
        	   ,A.TRUBL_MDAT_SE
		       ,DATE_FORMAT(C.CRTE_DTTM, '%Y-%m-%d %H:%i:%s') AS REQ_DT
			   ,DATE_FORMAT(C.UPDT_DTTM, '%Y-%m-%d %H:%i:%s') AS RCEPT_DT
			   ,CASE WHEN A.CI = #{login_user_ci} THEN 'B'
			   		 WHEN A.D_CI = #{login_user_ci} THEN 'B'
			   		 WHEN A.P_D_CI = #{login_user_ci} THEN 'P'
			   		 WHEN A.P_CI = #{login_user_ci} THEN 'P'
                     WHEN FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) =#{cttpc}),ADA.P_BIZRNO_LIST) > 0 THEN 'P'
					 WHEN FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE P_CI = #{login_user_ci}),ADA.P_BIZRNO_LIST) > 0 THEN 'P'
					 END AS TRGET
		       ,A.NM
		       ,ADA.P_BSNM_NM_LIST AS P_NM
		       ,A.STTUS
		       ,A.REQST_REASON
		       ,E.PROCESS_SE
		       /*TM009, TM994 직권조정일 경우 */
		       ,IF(A.STTUS = 'TM009' OR A.STTUS = 'TM994',A.OCTHT_ISSU,A.MDAT_CONFM) AS MDAT_CONFM
		       ,A.MDAT_BFE_CNCRRNC_CONFM
		       ,A.ED_CONFM
		       ,F_COMM_USER_NM(A.CHARGER_ID) AS CHARGER_NM
			   ,DATE_FORMAT(A.TREDE, '%Y-%m-%d') AS TREDE
			   ,DATE_FORMAT(DATE_ADD(A.RCEPT_DT, INTERVAL  14 DAY), '%Y-%m-%d') AS FACTCONF_DT
			   ,B.ENDD
               ,FH.MAXCTTM
               ,CASE WHEN FH.MAXCTTM IS NOT NULL AND FH.MAXCTTM != '' THEN 'ture'
                ELSE 'false' END AS ISNEW
		       ,(
			   SELECT COUNT(*)
			  	   FROM CYL_KAIT_TRUBL_MDAT_MST A LEFT OUTER JOIN CYL_KAIT_TRUBL_MDAT_DTL B
				                                  ON A.TRUBL_MDAT_NO = B.TRUBL_MDAT_NO
				                                  INNER JOIN CYL_CMM_DB_USE_MAPNG C
												  ON A.TRUBL_MDAT_NO = C.MAPNG_KEY
					 							  AND C.MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
					 							  AND C.USE_YN = 'Y'
					 							  LEFT OUTER JOIN (SELECT A.TRUBL_MDAT_NO
															      		  ,MAX(A.SN) AS SN
																    FROM CYL_KAIT_TRUBL_MDAT_JOB_HIST A GROUP BY TRUBL_MDAT_NO) D
								  				  ON A.TRUBL_MDAT_NO = D.TRUBL_MDAT_NO
								  				  LEFT OUTER JOIN CYL_KAIT_TRUBL_MDAT_JOB_HIST E
								  				  ON A.TRUBL_MDAT_NO = E.TRUBL_MDAT_NO
								  				  AND D.SN = E.SN
												  LEFT OUTER JOIN ( SELECT TRUBL_MDAT_NO
												 						 , GROUP_CONCAT(BSNM.BIZRNO SEPARATOR ',') AS P_BIZRNO_LIST
																		 , GROUP_CONCAT(BSNM.BSNM_NM SEPARATOR ',') AS P_BSNM_NM_LIST
												  					  FROM CYL_KAIT_ADD_APPLCNT_INFO AINFO
																	  INNER JOIN CYL_KAIT_BSNM BSNM
												  							  ON BSNM.BSNM_CD = AINFO.BSNM_CD
												  					  GROUP BY TRUBL_MDAT_NO) ADA
												  ON A.TRUBL_MDAT_NO = ADA.TRUBL_MDAT_NO
        <include refid="incCond"/>
			   ) AS TOT
		   FROM CYL_KAIT_TRUBL_MDAT_MST A LEFT OUTER JOIN CYL_KAIT_TRUBL_MDAT_DTL B
		                                  ON A.TRUBL_MDAT_NO = B.TRUBL_MDAT_NO
		                                  INNER JOIN CYL_CMM_DB_USE_MAPNG C
										  ON A.TRUBL_MDAT_NO = C.MAPNG_KEY
			 							  AND C.MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
			 							  AND C.USE_YN = 'Y'
			 							  LEFT OUTER JOIN (SELECT A.TRUBL_MDAT_NO
															      ,MAX(A.SN) AS SN
														    FROM CYL_KAIT_TRUBL_MDAT_JOB_HIST A GROUP BY TRUBL_MDAT_NO) D
						  				  ON A.TRUBL_MDAT_NO = D.TRUBL_MDAT_NO
						  				  LEFT OUTER JOIN CYL_KAIT_TRUBL_MDAT_JOB_HIST E
						  				  ON A.TRUBL_MDAT_NO = E.TRUBL_MDAT_NO
						  				  AND D.SN = E.SN
										  LEFT OUTER JOIN ( SELECT TRUBL_MDAT_NO
										  						 , GROUP_CONCAT(BSNM.BIZRNO SEPARATOR ',') AS P_BIZRNO_LIST
																 , GROUP_CONCAT(BSNM.BSNM_NM SEPARATOR ',') AS P_BSNM_NM_LIST
										  					  FROM CYL_KAIT_ADD_APPLCNT_INFO AINFO INNER JOIN CYL_KAIT_BSNM BSNM
										  																   ON BSNM.BSNM_CD = AINFO.BSNM_CD
										  				  GROUP BY TRUBL_MDAT_NO) ADA
										  ON A.TRUBL_MDAT_NO = ADA.TRUBL_MDAT_NO
                                          left outer join (
                                            select
                                            a.TRUBL_MDAT_NO, max(a.CRTE_DTTM) as order_col
                                            from
                                            cyl_kait_trubl_mdat_sttus_hist a group by a.TRUBL_MDAT_NO
                                          ) as order_table
                                          on A.TRUBL_MDAT_NO = order_table.TRUBL_MDAT_NO
                                          LEFT OUTER JOIN(
                                            SELECT MAX(CRTE_DTTM) AS MAXCTTM, TRUBL_MDAT_NO FROM CYL_KAIT_FILE_HIST
                                            WHERE 1=1 and CRTE_DTTM > DATE_SUB(NOW(),INTERVAL 7 DAY)
                                            and TRGET in ('A','P') AND ACT='ADD' AND APPLICANT_VIEWYN='N' GROUP BY TRUBL_MDAT_NO
                                          ) AS FH ON FH.TRUBL_MDAT_NO = A.TRUBL_MDAT_NO
        <include refid="incCond"/>
        ORDER BY A.TRUBL_MDAT_NO DESC
        <include refid="CylCmm.suffixPagination"/>
    </select>

    <select id="view" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.view : 나의사건 조회 상세 */
        SELECT A.TRUBL_MDAT_NO
                ,A.TRUBL_MDAT_SE
                ,CASE WHEN A.CI = #{login_user_ci} THEN 'A'
                    WHEN A.D_CI = #{login_user_ci} THEN 'D'
                    END AS SE
                ,DATE_FORMAT(C.CRTE_DTTM, '%Y-%m-%d %H:%i:%s') AS REQ_DT
                ,DATE_FORMAT(C.UPDT_DTTM, '%Y-%m-%d %H:%i:%s') AS RCEPT_DT
                ,DATE_FORMAT(A.TREDE, '%Y-%m-%d') AS TREDE
                ,F_COMM_CODE_NM('CYL001',A.TRUBL_MDAT_SE) AS TRUBL_MDAT_SE_NM
                ,F_COMM_CODE_NM('CYL024',A.INOUT_SE) AS INOUT_SE
                ,A.NM
                ,A.CTTPC
                ,SUBSTRING_INDEX(A.CTTPC,'-', 1) AS PHONE1
                ,SUBSTRING_INDEX(SUBSTRING_INDEX(A.CTTPC, '-', -2),'-',1) AS PHONE2
                ,SUBSTRING_INDEX(A.CTTPC,'-', -1) AS PHONE3
                ,A.BRTHDY
                ,A.ZIP
                ,A.ADRES
                ,A.EMAIL
                ,SUBSTRING_INDEX(A.EMAIL,'@', 1) AS EMAIL1
                ,SUBSTRING_INDEX(A.EMAIL,'@', -1) AS EMAIL2
                ,A.DETAIL_ADRES
                ,A.BSNM_CD
                ,A.BIZRNO
                ,A.P_NM
                ,A.P_URL
                ,A.P_CTTPC
                ,SUBSTRING_INDEX(A.P_CTTPC,'-', 1) AS P_PHONE1
                ,SUBSTRING_INDEX(SUBSTRING_INDEX(A.P_CTTPC, '-', -2),'-',1) AS P_PHONE2
                ,SUBSTRING_INDEX(A.P_CTTPC,'-', -1) AS P_PHONE3
                ,A.P_EMAIL
                ,SUBSTRING_INDEX(A.P_EMAIL,'@', 1) AS P_EMAIL1
                ,SUBSTRING_INDEX(A.P_EMAIL,'@', -1) AS P_EMAIL2
                ,A.P_ZIP
                ,A.P_ADRES
                ,A.P_DETAIL_ADRES
				,F_COMM_SCLSRT_CODE_NM('DM_TY',A.DM_TY_L) AS DM_TY_L_NM
			    ,F_COMM_SCLSRT_CODE_NM('DM_TY',A.DM_TY_M) AS DM_TY_M_NM
			    ,F_COMM_SCLSRT_CODE_NM('DM_TY',A.DM_TY_S) AS DM_TY_S_NM
			    ,A.DEMAND_MATTER_ITEM
                <!--나의사건조회 대리인 상세 -->
                ,B.NM AS AGENT_NM
                ,B.CTTPC AS AGENT_CTTPC
                ,B.BRTHDY AS AGENT_BRTHDY
                ,B.EMAIL AS AGENT_EMAIL
                ,B.ZIP AS AGENT_ZIP
                ,B.ADRES AS AGENT_ADRES
                ,B.DETAIL_ADRES AS AGENT_DETAIL_ADRES
                ,B.NM AS AGENT_NM
                <!-- -->
                <!--나의사건조회 대리인 수정 -->
                ,B.NM AS A_NM
                ,B.CTTPC AS A_CTTPC
                ,SUBSTRING_INDEX(B.CTTPC,'-', 1) AS A_CTTPC1
                ,SUBSTRING_INDEX(SUBSTRING_INDEX(B.CTTPC, '-', -2),'-',1) AS A_CTTPC2
                ,SUBSTRING_INDEX(B.CTTPC,'-', -1) AS A_CTTPC3
                ,B.BRTHDY AS A_BRTHDY
                ,B.EMAIL AS A_EMAIL
                ,SUBSTRING_INDEX(B.EMAIL,'@', 1) AS A_EMAIL1
                ,SUBSTRING_INDEX(B.EMAIL,'@', -1) AS A_EMAIL2
                ,B.ZIP AS A_ZIP
                ,B.ADRES AS A_ADRES
                ,B.DETAIL_ADRES AS A_DETAIL_ADRES
                ,B.RELATE
                ,B.RELATE_RELTIV
                <!-- -->
                ,B.D_NM
                ,B.D_CTTPC
                ,B.D_BRTHDY
                ,B.D_EMAIL
                ,B.D_ZIP
                ,B.D_ADRES
                ,B.D_DETAIL_ADRES
                ,B.ENDD
                ,A.STTUS
                ,F_COMM_CODE_NM('CYL002',A.STTUS) AS STTUS_NM
                ,F_COMM_USER_NM(A.CHARGER_ID) AS CHARGER_NM
                ,F.CTTPC AS CHARGER_CTTPC
                ,A.REQST_REASON
                ,A.DEMAND_MATTER
                ,E.PROCESS_SE
                /*TM009, TM994 직권조정일 경우 */
                ,IF(A.STTUS = 'TM009' OR A.STTUS = 'TM994',A.OCTHT_MDAT_CONFM,A.MDAT_CONFM) AS MDAT_CONFM
                ,A.MDAT_BFE_CNCRRNC_CONFM
                ,A.ED_CONFM
                ,CONCAT(A.TRUBL_MDAT_NO,' %') AS FILE_KEY_HIST
                ,CONCAT(A.TRUBL_MDAT_NO,' ','TM005') AS FILE_KEY_05
                ,CONCAT(A.TRUBL_MDAT_NO,' ','TM003') AS FILE_KEY_03
                ,A.CI
                ,A.P_CI
        FROM CYL_KAIT_TRUBL_MDAT_MST A INNER JOIN CYL_KAIT_TRUBL_MDAT_DTL B
                     ON A.TRUBL_MDAT_NO = B.TRUBL_MDAT_NO
                                       INNER JOIN CYL_CMM_DB_USE_MAPNG C
                     ON A.TRUBL_MDAT_NO = C.MAPNG_KEY
                            AND C.MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
                            AND C.USE_YN = 'Y'
                                       LEFT OUTER JOIN (SELECT A.TRUBL_MDAT_NO
                                                                ,MAX(A.SN) AS SN
                                                        FROM CYL_KAIT_TRUBL_MDAT_JOB_HIST A GROUP BY TRUBL_MDAT_NO) D
                     ON A.TRUBL_MDAT_NO = D.TRUBL_MDAT_NO
                                       LEFT OUTER JOIN CYL_KAIT_TRUBL_MDAT_JOB_HIST E
                     ON A.TRUBL_MDAT_NO = E.TRUBL_MDAT_NO
                            AND D.SN = E.SN
                                       LEFT JOIN CYL_CMM_0100_TN F
                     ON A.CHARGER_ID = F.USER_ID
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
    </select>

    <select id="opinion" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.opinion : 나의사건조회 의견 조회 */
        SELECT A.TRUBL_MDAT_NO
                ,A.SE
                ,A.SN
                ,A.OPINION
                ,F_COMM_FILE_ID(CONCAT(A.TRUBL_MDAT_NO,' ',A.SE,' ',A.SN),'CYL_KAIT_OPINION','ATCH_FILE_ID',1) AS ATCH_FILE_ID
                ,F_COMM_FILE_NM(F_COMM_FILE_ID(CONCAT(A.TRUBL_MDAT_NO,' ',A.SE,' ',A.SN),'CYL_KAIT_OPINION','ATCH_FILE_ID',1)) AS ATCH_FILE_ID_NM
        FROM CYL_KAIT_OPINION A INNER JOIN CYL_KAIT_TRUBL_MDAT_MST B
                     ON A.TRUBL_MDAT_NO = B.TRUBL_MDAT_NO
                                INNER JOIN CYL_CMM_DB_USE_MAPNG C
                     ON CONCAT(A.TRUBL_MDAT_NO,' ',A.SE,' ',A.SN) = C.MAPNG_KEY
                            AND C.MAPNG_TABLE = 'CYL_KAIT_OPINION'
                            AND C.USE_YN = 'Y'
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
        ORDER BY C.CRTE_DTTM ASC
    </select>

    <select id="plist" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.plist : 개인 분쟁조정 요건/서류검토 피신청자 목록*/
        SELECT A.TRUBL_MDAT_NO
                ,A.SN
                ,A.NM
                ,A.CTTPC
                ,A.D_NM
                ,A.D_CTTPC
        FROM CYL_KAIT_ADD_APPLCNT_INFO A
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
        ORDER BY A.SN ASC
    </select>

    <select id="histView" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.histView : 나의사건 조회 history정보 상세 */
        SELECT A.TRUBL_MDAT_NO
                ,MAX(A.SN) AS SN
                ,A.PROCESS_SE
                ,A.CN
        FROM CYL_KAIT_TRUBL_MDAT_JOB_HIST A
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
        GROUP BY TRUBL_MDAT_NO
    </select>

    <select id="papersView" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.papersView : 나의사건 조회 구비서류 조회 */
        SELECT A.TRUBL_MDAT_NO
                ,CONCAT(A.TRUBL_MDAT_NO,' ','PAPERS') AS FILE_KEY_PAPERS
        FROM CYL_KAIT_TRUBL_MDAT_MST A
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
    </select>

    <select id="papersFilelist" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.papersFilelist : 나의사건 조회 구비서류 첨부파일 조회 */
        SELECT A.MAPNG_KEY
                ,A.COLUNM_NM
                ,F_COMM_FILE_ID(A.MAPNG_KEY,A.MAPNG_TABLE,A.COLUNM_NM,1) AS FILE_ID
                ,F_COMM_FILE_NM(F_COMM_FILE_ID(A.MAPNG_KEY,A.MAPNG_TABLE,A.COLUNM_NM,1)) AS FILE_NM
        FROM CYL_CMM_FILE_MAPNG A
        WHERE A.MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
          AND A.COLUNM_NM IN ('MDAT_FILE','P_MDAT_FILE','MDATAGR','PMDATAGR','MDATCNCRRNC','PMDATCNCRRNC')
          AND A.MAPNG_KEY LIKE CONCAT(#{trubl_mdat_no})
        ORDER BY A.MAPNG_KEY DESC, A.COLUNM_NM ASC
    </select>

    <update id="update" parameterType="paramMap">
        /* MyIncdnt.update : 나의사건 조회 등록 및 수정 */
        <selectKey order="BEFORE" keyProperty="sn" resultType="String">
            SELECT IFNULL(MAX(SN) + 1,1) AS SN
            FROM CYL_KAIT_TRUBL_MDAT_JOB_HIST
            WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};
        </selectKey>
        SET @MY_SN = 0;
        SELECT IFNULL(MAX(SN) + 1,1) INTO @MY_SN
        FROM CYL_KAIT_OPINION
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
        AND SE = #{trget};

        INSERT INTO
        CYL_KAIT_OPINION
        (
            TRUBL_MDAT_NO
            ,SE
            ,SN
            ,OPINION
        ) VALUES (
            #{trubl_mdat_no}
            ,#{trget}
            ,@MY_SN
            ,#{opinion}
        );

        <if test="atch_file_id != null and atch_file_id != ''">
            DELETE
            FROM CYL_CMM_FILE_MAPNG
            WHERE MAPNG_TABLE = 'CYL_KAIT_OPINION'
            AND MAPNG_KEY = CONCAT(#{trubl_mdat_no},' ',#{trget},' ',@MY_SN);

            INSERT INTO
            CYL_CMM_FILE_MAPNG
            (
                MAPNG_KEY
                ,MAPNG_TABLE
                ,ATCH_FILE_ID
                ,COLUNM_NM
                ,SN
                ,CRTE_USER_ID
                ,CRTE_DTTM
            ) VALUES (
            CONCAT(#{trubl_mdat_no},' ',#{trget},' ',@MY_SN)
                ,'CYL_KAIT_OPINION'
                ,#{atch_file_id}
                ,'ATCH_FILE_ID'
                ,1
                ,#{login_user_id}
                ,NOW()
            );
        </if>

        INSERT INTO CYL_CMM_DB_USE_MAPNG
        (
            MAPNG_KEY
            ,MAPNG_TABLE
            ,USE_YN
            ,CRTE_USER_ID
            ,CRTE_DTTM
        ) VALUES (
        CONCAT(#{trubl_mdat_no},' ',#{trget},' ',@MY_SN)
            ,'CYL_KAIT_OPINION'
            ,'Y'
            ,#{login_user_id}
            ,NOW()
        );
    </update>

    <update id="modify" parameterType="paramMap">
        /* MyIncdnt.modify : 나의사건 조회 분쟁조정신청 */
        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET NM = #{nm}
        ,BRTHDY = #{brthdy}
        ,CTTPC = #{cttpc}
        ,EMAIL = #{email}
        ,ZIP = #{zip}
        ,ADRES = #{adres}
        ,DETAIL_ADRES = #{detail_adres}
        ,P_NM = #{p_nm}
        ,P_URL = #{p_url}
        ,P_CTTPC = #{p_cttpc}
        ,P_EMAIL = #{p_email}
        ,P_ZIP = #{p_zip}
        ,P_ADRES = #{p_adres}
        ,P_DETAIL_ADRES = #{p_detail_adres}
        ,TREDE = #{trede}
        ,CHARGER_ID  = F_GET_CHARGER_ID(#{trubl_mdat_no})
        ,STTUS = 'TM001'
        ,REQST_REASON = #{reqst_reason}
        ,DEMAND_MATTER = #{demand_matter}
        <if test="demand_matter_item_list != null and demand_matter_item_list != ''">
            ,DEMAND_MATTER_ITEM =
            <if test="demand_matter_item_list != null and demand_matter_item_list != ''">
                <foreach collection="demand_matter_item_list" item="vo" index="i" open="CONCAT(" close=")" separator=",">
                    <if test="i == 0"> #{vo.demand_matter_item}</if>
                    <if test="i >= 1"> CONCAT(',' , #{vo.demand_matter_item})</if>
                </foreach>
            </if>
        </if>
        ,BSNM_CD = #{bsnm_cd}
        ,BIZRNO = #{bizrno}
        ,LOGIN_DEVICE = #{login_device}
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};

        UPDATE CYL_KAIT_TRUBL_MDAT_DTL
        SET NM = #{a_nm}
        , BRTHDY = #{a_brthdy}
        , CTTPC = #{a_cttpc}
        , EMAIL = #{a_email}
        , ZIP = #{a_zip}
        , ADRES = #{a_adres}
        , DETAIL_ADRES = #{a_detail_adres}
        , RELATE = #{relate}
        , RELATE_RELTIV = #{relate_reltiv}
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};

        DELETE FROM CYL_KAIT_ADD_APPLCNT_INFO
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};

        <if test="sreqList != null and sreqList != ''">
            <foreach separator="" item="vo" index="i" collection="sreqList">
                INSERT INTO
                CYL_KAIT_ADD_APPLCNT_INFO
                (
                TRUBL_MDAT_NO
                ,SN
                ,NM
                ,BIZRNO
                ,URL
                ,CTTPC
                ,EMAIL
                ,ZIP
                ,ADRES
                ,DETAIL_ADRES
                ,BSNM_CD
                ) VALUES (
                #{trubl_mdat_no}
                ,(SELECT IFNULL(MAX(SN)+1,1)AS SN FROM CYL_KAIT_ADD_APPLCNT_INFO B)
                ,#{vo.nm}
                ,#{vo.bizrno}
                ,#{vo.url}
                ,#{vo.cttpc}
                ,#{vo.email}
                ,#{vo.zip}
                ,#{vo.adres}
                ,#{vo.detail_adres}
                ,#{vo.bsnm_cd}
                );
            </foreach>
        </if>

        DELETE FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_KEY = #{trubl_mdat_no}
        AND MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
        AND COLUNM_NM LIKE 'INDIV_FILE_%';

        <if test="indiv_file_list != null and indiv_file_list != ''">
            <foreach separator="" item="vo" index="i" collection="indiv_file_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG (
                MAPNG_KEY
                ,MAPNG_TABLE
                ,ATCH_FILE_ID
                ,COLUNM_NM
                ,SN
                ,CRTE_USER_ID
                ,CRTE_DTTM
                ) VALUES (
                #{trubl_mdat_no}
                ,'CYL_KAIT_TRUBL_MDAT_MST'
                ,#{vo.ATCH_FILE_KEY}
                ,#{vo.COLUNM_NM}
                ,1
                ,#{login_user_id}
                ,current_timestamp()
                );
            </foreach>
        </if>

        DELETE FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_KEY = #{trubl_mdat_no}
        AND MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
        AND COLUNM_NM LIKE 'AGENT_FILE_%';

        <if test="agent_file_list != null and agent_file_list != ''">
            <foreach separator="" item="vo" index="i" collection="agent_file_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG (
                MAPNG_KEY
                ,MAPNG_TABLE
                ,ATCH_FILE_ID
                ,COLUNM_NM
                ,SN
                ,CRTE_USER_ID
                ,CRTE_DTTM
                ) VALUES (
                #{trubl_mdat_no}
                ,'CYL_KAIT_TRUBL_MDAT_MST'
                ,#{vo.ATCH_FILE_KEY}
                ,#{vo.COLUNM_NM}
                ,1
                ,#{login_user_id}
                ,current_timestamp()
                );
            </foreach>
        </if>
    </update>

    <update id="tmprUpdate" parameterType="paramMap">
        /* MyIncdnt.tmprUpdate : 나의사건 조회 임시저장 */
        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET NM = #{nm}
            ,BRTHDY = #{brthdy}
            ,CTTPC = #{cttpc}
            ,EMAIL = #{email}
            ,ZIP = #{zip}
            ,ADRES = #{adres}
            ,DETAIL_ADRES = #{detail_adres}
            ,P_NM = #{p_nm}
            ,P_URL = #{p_url}
            ,P_CTTPC = #{p_cttpc}
            ,P_EMAIL = #{p_email}
            ,P_ZIP = #{p_zip}
            ,P_ADRES = #{p_adres}
            ,P_DETAIL_ADRES = #{p_detail_adres}
            ,REQST_REASON = #{reqst_reason}
            ,DEMAND_MATTER = #{demand_matter}
        <if test="demand_matter_item_list != null and demand_matter_item_list != ''">
            ,DEMAND_MATTER_ITEM =
            <if test="demand_matter_item_list != null and demand_matter_item_list != ''">
                <foreach collection="demand_matter_item_list" item="vo" index="i" open="CONCAT(" close=")" separator=",">
                    <if test="i == 0"> #{vo.demand_matter_item}</if>
                    <if test="i >= 1"> CONCAT(',' , #{vo.demand_matter_item})</if>
                </foreach>
            </if>
        </if>
        ,BSNM_CD = #{bsnm_cd}
        ,BIZRNO = #{bizrno}
        ,LOGIN_DEVICE = #{login_device}
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};

        UPDATE CYL_KAIT_TRUBL_MDAT_DTL
        SET NM = #{a_nm}
            , BRTHDY = #{a_brthdy}
            , CTTPC = #{a_cttpc}
            , EMAIL = #{a_email}
            , ZIP = #{a_zip}
            , ADRES = #{a_adres}
            , DETAIL_ADRES = #{a_detail_adres}
            , RELATE = #{relate}
            , RELATE_RELTIV = #{relate_reltiv}
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};

        DELETE FROM CYL_KAIT_ADD_APPLCNT_INFO
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};

        <if test="sreqList != null and sreqList != ''">
            <foreach separator="" item="vo" index="i" collection="sreqList">
                INSERT INTO
                CYL_KAIT_ADD_APPLCNT_INFO
                (
                    TRUBL_MDAT_NO
                    ,SN
                    ,NM
                    ,BIZRNO
                    ,URL
                    ,CTTPC
                    ,EMAIL
                    ,ZIP
                    ,ADRES
                    ,DETAIL_ADRES
                    ,BSNM_CD
                ) VALUES (
                    #{trubl_mdat_no}
                    ,(SELECT IFNULL(MAX(SN)+1,1)AS SN FROM CYL_KAIT_ADD_APPLCNT_INFO B)
                    ,#{vo.nm}
                    ,#{vo.bizrno}
                    ,#{vo.url}
                    ,#{vo.cttpc}
                    ,#{vo.email}
                    ,#{vo.zip}
                    ,#{vo.adres}
                    ,#{vo.detail_adres}
                    ,#{vo.bsnm_cd}
                );
            </foreach>
        </if>

        DELETE FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_KEY = #{trubl_mdat_no}
        AND MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
        AND COLUNM_NM LIKE 'INDIV_FILE_%';

        <if test="indiv_file_list != null and indiv_file_list != ''">
            <foreach separator="" item="vo" index="i" collection="indiv_file_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG (
                    MAPNG_KEY
                    ,MAPNG_TABLE
                    ,ATCH_FILE_ID
                    ,COLUNM_NM
                    ,SN
                    ,CRTE_USER_ID
                    ,CRTE_DTTM
                ) VALUES (
                    #{trubl_mdat_no}
                    ,'CYL_KAIT_TRUBL_MDAT_MST'
                    ,#{vo.ATCH_FILE_KEY}
                    ,#{vo.COLUNM_NM}
                    ,1
                    ,#{login_user_id}
                    ,current_timestamp()
                );
            </foreach>
        </if>

        DELETE FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_KEY = #{trubl_mdat_no}
        AND MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
        AND COLUNM_NM LIKE 'AGENT_FILE_%';

        <if test="agent_file_list != null and agent_file_list != ''">
            <foreach separator="" item="vo" index="i" collection="agent_file_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG (
                    MAPNG_KEY
                    ,MAPNG_TABLE
                    ,ATCH_FILE_ID
                    ,COLUNM_NM
                    ,SN
                    ,CRTE_USER_ID
                    ,CRTE_DTTM
                ) VALUES (
                    #{trubl_mdat_no}
                    ,'CYL_KAIT_TRUBL_MDAT_MST'
                    ,#{vo.ATCH_FILE_KEY}
                    ,#{vo.COLUNM_NM}
                    ,1
                    ,#{login_user_id}
                    ,current_timestamp()
                );
            </foreach>
        </if>
    </update>

    <insert id="updateRevisionCompl">
        /* MyIncdnt.updateRevisionCompl : 나의사건 조회 보정완료처리 */
        <selectKey order="BEFORE" keyProperty="sn" resultType="String">
            SELECT IFNULL(MAX(SN) + 1,1) AS SN
            FROM CYL_KAIT_TRUBL_MDAT_JOB_HIST
            WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};
        </selectKey>

        INSERT INTO
        CYL_KAIT_TRUBL_MDAT_JOB_HIST
        (
            TRUBL_MDAT_NO
            ,SN
            ,STTUS
            ,PROCESS_SE
            ,SMS
            ,CN
        ) VALUES (
            #{trubl_mdat_no}
            ,#{sn}
            ,(SELECT STTUS FROM CYL_KAIT_TRUBL_MDAT_MST WHERE TRUBL_MDAT_NO = #{trubl_mdat_no})
            ,'O'
            ,null
            ,'신청인이 신청서를 보정 완료했습니다.'
        );


        INSERT INTO
        CYL_CMM_DB_USE_MAPNG
        (
            MAPNG_KEY
            ,MAPNG_TABLE
            ,CRTE_USER_ID
            ,CRTE_DTTM
        ) VALUES (
            CONCAT(#{trubl_mdat_no},' ',#{sn})
            ,'CYL_KAIT_TRUBL_MDAT_JOB_HIST'
            ,#{login_user_id}
            ,NOW()
        );
    </insert>

    <update id="updateFile" parameterType="paramMap">
        <if test="file_list != null and file_list != ''">
            DELETE
            FROM CYL_CMM_FILE_MAPNG
            WHERE MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
            AND MAPNG_KEY = CONCAT(#{trubl_mdat_no});
            <foreach separator="" item="vo" index="i" collection="file_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG
                (
                    MAPNG_KEY
                    ,MAPNG_TABLE
                    ,ATCH_FILE_ID
                    ,COLUNM_NM
                    ,SN
                    ,CRTE_USER_ID
                    ,CRTE_DTTM
                ) VALUES (
                    #{trubl_mdat_no}
                    ,'CYL_KAIT_TRUBL_MDAT_MST'
                    ,#{vo.ATCH_FILE_KEY}
                    ,#{vo.COLUNM_NM}
                    ,1
                    ,#{login_user_id}
                    ,NOW()
                );
            </foreach>
        </if>

        <if test="etc_list != null and etc_list != ''">
            DELETE
            FROM CYL_CMM_FILE_MAPNG
            WHERE MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
            AND MAPNG_KEY = CONCAT(#{trubl_mdat_no},' ','TM003');
            <foreach separator="" item="vo" index="i" collection="etc_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG
                (
                    MAPNG_KEY
                    ,MAPNG_TABLE
                    ,ATCH_FILE_ID
                    ,COLUNM_NM
                    ,SN
                    ,CRTE_USER_ID
                    ,CRTE_DTTM
                ) VALUES (
                    CONCAT(#{trubl_mdat_no},' ','TM003')
                    ,'CYL_KAIT_TRUBL_MDAT_MST'
                    ,#{vo.ATCH_FILE_KEY}
                    ,#{vo.COLUNM_NM}
                    ,1
                    ,#{login_user_id}
                    ,NOW()
                );
            </foreach>
        </if>
    </update>

    <update id="updateFileP" parameterType="paramMap">
        DELETE
        FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
        AND MAPNG_KEY = CONCAT(#{trubl_mdat_no},' ','TM005');
        <if test="file_list != null and file_list != ''">
            <foreach separator="" item="vo" index="i" collection="file_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG
                (
                    MAPNG_KEY
                    ,MAPNG_TABLE
                    ,ATCH_FILE_ID
                    ,COLUNM_NM
                    ,SN
                    ,CRTE_USER_ID
                    ,CRTE_DTTM
                ) VALUES (
                    CONCAT(#{trubl_mdat_no},' ','TM005')
                    ,'CYL_KAIT_TRUBL_MDAT_MST'
                    ,#{vo.ATCH_FILE_KEY}
                    ,#{vo.COLUNM_NM}
                    ,1
                    ,#{login_user_id}
                    ,NOW()
                );
            </foreach>
        </if>
    </update>
    <!--[통신분쟁]2021-11-08 / Kait-72 / by ihpark / 피신청인 본인인증 인증서로 로그인 시 사건이 보이지 않는 오류 - 핸드폰 인증 이후에는 사건 매핑될 수 있게 변경 FIND_IN_SET 구문 추가-->
    <update id="autoIncdntCnnc" parameterType="paramMap">
        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET CI =
        <choose>
            <when test="self_info_ci == 'GUEST'">
                NULL
            </when>
            <otherwise>
                CASE WHEN REPLACE(CTTPC,'-','') = #{self_info_cttpc} THEN #{self_info_ci} END
            </otherwise>
        </choose>
        WHERE IFNULL(CI,'') = '';

        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET P_CI =
        <choose>
            <when test="self_info_ci == 'GUEST'">
                NULL
            </when>
            <otherwise>
                CASE WHEN REPLACE(P_CTTPC,'-','') = #{self_info_cttpc} THEN #{self_info_ci} END
            </otherwise>
        </choose>
        WHERE IFNULL(P_CI,'') = '';

        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET D_CI =
        <choose>
            <when test="self_info_ci == 'GUEST'">
                NULL
            </when>
            <otherwise>
                #{self_info_ci}
            </otherwise>
        </choose>
        WHERE TRUBL_MDAT_NO IN
        (
        SELECT A.TRUBL_MDAT_NO
        FROM CYL_KAIT_TRUBL_MDAT_DTL A
        WHERE REPLACE(A.CTTPC,'-','') = #{self_info_cttpc}
        )
        AND IFNULL(D_CI,'') = '';

        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET P_D_CI =
        <choose>
            <when test="self_info_ci == 'GUEST'">
                NULL
            </when>
            <otherwise>
                #{self_info_ci}
            </otherwise>
        </choose>
        WHERE TRUBL_MDAT_NO IN
        (
        SELECT T.TRUBL_MDAT_NO
        FROM (
            SELECT A.TRUBL_MDAT_NO
            FROM CYL_KAIT_TRUBL_MDAT_MST A INNER JOIN CYL_KAIT_ADD_APPLCNT_INFO B
            ON A.TRUBL_MDAT_NO = B.TRUBL_MDAT_NO
            AND A.P_CTTPC = B.CTTPC
            WHERE REPLACE(B.D_CTTPC,'-','') = #{self_info_cttpc}
        ) AS T
        )
        AND IFNULL(P_D_CI,'') = '';

        <if test="self_info_cttpc != null and self_info_cttpc !=''">
            UPDATE CYL_KAIT_BSNM_MNG
            SET P_CI =
            <choose>
                <when test="self_info_ci == 'GUEST'">
                    NULL
                </when>
                <otherwise>
                    #{self_info_ci}
                </otherwise>
            </choose>
            WHERE IFNULL(P_CI,'') = ''
            AND CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) = #{self_info_cttpc};
        </if>
    </update>
    <!--[통신분쟁]2021-08-30 / Kait-42,Kait-69 / by ihpark / 파일 이력관리 및 7일 이내 등록시 new 표시 -> file_hist_list추가-->
    <!--[통신분쟁]2021-06-23 / Kait-30 / by ihpark / 내부>접수배분, 분쟁조정> 단계별 문자발송 내용 수정(시스템 개선 전/후 구분) -> 동의/미동의 체크 구현-->
    <update id="updateFilePapers" parameterType="paramMap">
        <!--<if test="sttus != null and sttus != '' and sttus != 'TM995' and sttus != 'TM996' and sttus != 'TM997' and sttus != 'TM998' and sttus != 'TM999' and authentication_time != null and authentication_time !=''">
            update CYL_KAIT_TRUBL_MDAT_MST
                <choose>
                    <when test="'B'.toString() == trget">
                        set mdatCncrrnc_Yn = ifnull(#{mdatCncrrnc_Yn},'')
                        ,mdatAgr_Yn= ifnull(#{mdatAgr_Yn},'')
                        ,mdat2_Yn= ifnull(#{mdat2_Yn},'')
                        <if test="mdatCncrrnc_Dttm != null and mdatCncrrnc_Dttm != '' and cncrrncchangeyn == 'Y'.toString()">
                            ,mdatCncrrnc_Dttm = ifnull(date_format(#{mdatCncrrnc_Dttm},'%Y-%m-%d %H:%i'),null)
                            ,mdatCncrrnc_Cttm = ifnull(date_format(#{authentication_time},'%Y-%m-%d %H:%i'),null)
                        </if>
                        <if test="mdatAgr_Dttm != null and mdatAgr_Dttm != '' and agrchangeyn == 'Y'.toString()">
                            ,mdatAgr_Dttm = date_format(#{mdatAgr_Dttm},'%Y-%m-%d %H:%i')
                            ,mdatAgr_Cttm = date_format(#{authentication_time},'%Y-%m-%d %H:%i')
                        </if>
                        <if test="mdat2_Dttm != null and mdat2_Dttm != '' and mdat2changeyn == 'Y'.toString()">
                            ,mdat2_Dttm  = date_format(#{mdat2_Dttm},'%Y-%m-%d %H:%i')
                            ,mdat2_Cttm  = date_format(#{authentication_time},'%Y-%m-%d %H:%i')
                        </if>
                    </when>
                    <when test="'P'.toString() == trget">
                        set pmdatCncrrnc_Yn = ifnull(#{pmdatCncrrnc_Yn},'')
                        ,pmdatAgr_Yn= ifnull(#{pmdatAgr_Yn},'')
                        ,pmdat2_Yn= ifnull(#{pmdat2_Yn},'')
                        <if test="pmdatCncrrnc_Dttm != null and pmdatCncrrnc_Dttm != '' and cncrrncchangeyn == 'Y'.toString()">
                            ,pmdatCncrrnc_Dttm = ifnull(date_format(#{pmdatCncrrnc_Dttm},'%Y-%m-%d %H:%i'),null)
                            ,pmdatCncrrnc_Cttm = ifnull(date_format(#{authentication_time},'%Y-%m-%d %H:%i'),null)
                        </if>
                        <if test="pmdatAgr_Dttm != null and pmdatAgr_Dttm != '' and agrchangeyn == 'Y'.toString()">
                            ,pmdatAgr_Dttm = ifnull(date_format(#{pmdatAgr_Dttm},'%Y-%m-%d %H:%i'),null)
                            ,pmdatAgr_Cttm = ifnull(date_format(#{authentication_time},'%Y-%m-%d %H:%i'),null)
                        </if>
                        <if test="pmdat2_Dttm != null and pmdat2_Dttm != '' and mdat2changeyn == 'Y'.toString()">
                            ,pmdat2_Dttm = ifnull(date_format(#{pmdat2_Dttm},'%Y-%m-%d %H:%i'),null)
                            ,pmdat2_Cttm = ifnull(date_format(#{authentication_time},'%Y-%m-%d %H:%i'),null)
                        </if>
                    </when>
                </choose>
            where TRUBL_MDAT_NO=#{trubl_mdat_no};
        </if>-->
        <if test="colunm_list != null and colunm_list != ''">
            <foreach separator="" item="vo" index="i" collection="colunm_list" open="" close="">
                DELETE
                FROM CYL_CMM_FILE_MAPNG
                WHERE MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
                AND MAPNG_KEY = #{trubl_mdat_no}
                AND COLUNM_NM LIKE CONCAT(#{vo.colunm_nm},'%');
            </foreach>
        </if>

        <if test="file_list != null and file_list != ''">
            <foreach separator="" item="vo" index="i" collection="file_list">
                INSERT INTO
                CYL_CMM_FILE_MAPNG
                (
                MAPNG_KEY
                ,MAPNG_TABLE
                ,ATCH_FILE_ID
                ,COLUNM_NM
                ,SN
                ,CRTE_USER_ID
                ,CRTE_DTTM
                ) VALUES (
                #{trubl_mdat_no}
                ,'CYL_KAIT_TRUBL_MDAT_MST'
                ,#{vo.ATCH_FILE_KEY}
                ,#{vo.COLUNM_NM}
                ,1
                ,#{login_user_id}
                ,NOW()
                );
            </foreach>
        </if>

        <if test="file_hist_list != null and file_hist_list != ''">
            <foreach separator="" item="vo" index="i" collection="file_hist_list">
                SET @FILE_HIST_SN = '';
                select ifnull(max(HIST_SN)+1,1) INTO @FILE_HIST_SN from cyl_kait_file_hist where TRUBL_MDAT_NO=#{vo.trubl_mdat_no};
                INSERT INTO
                    cyl_kait_file_hist
                    (
                        TRUBL_MDAT_NO,
                        HIST_SN,
                        ORIGIN_FILE_NM,
                        ATCH_FILE_ID,
                        ACT,
                        TRGET,
                        STTUS,
                        COLUNM_NM,
                        CRTE_DTTM
                    ) VALUES (
                         #{vo.trubl_mdat_no}
                        ,@FILE_HIST_SN
                        ,#{vo.origin_file_nm}
                        ,#{vo.atch_file_id}
                        ,#{vo.act}
                        ,#{vo.trget}
                        ,#{vo.sttus}
                        ,#{vo.colunm_nm}
                        ,date_format(#{vo.crte_dttm},'%Y-%m-%d %H:%i:%S')
                    );
            </foreach>
        </if>
    </update>

    <delete id="delete" parameterType="paramMap">
        DELETE
        FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
        AND MAPNG_KEY = #{trubl_mdat_no}
        AND COLUNM_NM LIKE #{colunm_nm}
        <if test="atch_file_id != null and atch_file_id!= ''">
            AND ATCH_FILE_ID = #{atch_file_id}
        </if>
    </delete>

    <update id="mdatReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_MDAT_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_MDAT_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_MDAT_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_MDAT_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>
    <!-- [통신분쟁]2021-05-04 / Kait-4 / by ihpark / 접수/배분단계 사건취소 기능 구현-->
    <select id="selectSttus" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.selectSttus : 나의사건 sttus 조회 */
        SELECT A.STTUS
        FROM CYL_KAIT_TRUBL_MDAT_MST A
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
    </select>

    <select id="selectAtchFileList" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.selectAtchFileList : 나의사건 첨부파일 조회 조회 */
        SELECT ATCH_FILE_ID
        FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_KEY = #{trubl_mdat_no}
        AND MAPNG_TABLE = 'CYL_KAIT_TRUBL_MDAT_MST'
    </select>

    <update id="myincdntCancel" parameterType="paramMap">
        update cyl_cmm_db_use_mapng a
        set a.USE_YN ='N'
        where a.MAPNG_KEY = #{trubl_mdat_no};

        <if test="file_list != null and file_list != ''">
            <foreach collection="file_list" item="vo" index="i" separator="">
                UPDATE CYL_CMM_0401_TN
                SET USE_AT = 'N'
                WHERE ATCH_FILE_ID = #{vo.FILE};
            </foreach>
        </if>
    </update>

    <!-- [통신분쟁]2021-06-23 / Kait-30 / by ihpark / 내부>접수배분, 분쟁조정> 단계별 문자발송 내용 수정(시스템 개선 전/후 구분) -> 동의/미동의 체크 구현 -->
    <select id="selectAgrYn" parameterType="paramMap" resultType="paramMap">
        /* MyIncdnt.selectAgrYn : 나의사건 동의여부 조회 */
        SELECT A.mdatCncrrnc_Yn, A.pmdatCncrrnc_Yn, A.mdatAgr_Yn, A.pmdatAgr_Yn, A.mdat2_Yn, A.pmdat2_Yn
        FROM CYL_KAIT_TRUBL_MDAT_MST A
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
    </select>

    <!--[통신분쟁]2022-01-04 / Kait-81 / by ihpark / 나의사건조회 cond_trget오류 수정 -> 미사용-->
    <!--[통신분쟁]2021-07-30 / Kait-49 / by ihpark / 신청인/피신청인 구분에 따른 나의사건조회 order by 변경 및 리스트 변경-->
    <select id="getTrget" parameterType="map" resultType="paramMap">
            select
        			A.TRUBL_MDAT_NO, A.CI ,A.D_CI ,A.P_D_CI , A.P_CI
        			,case
        				when A.CI = #{login_user_ci} then 'B'
        				when A.D_CI = #{login_user_ci} then 'B'
        				when A.P_D_CI = #{login_user_ci} then 'P'
        				when A.P_CI = #{login_user_ci} then 'P'
        				when FIND_IN_SET((select BIZRNO from CYL_KAIT_BSNM_MNG where CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) = #{cttpc}), ADA.P_BIZRNO_LIST) > 0 then 'P'
                        when FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE P_CI = #{login_user_ci}),ADA.P_BIZRNO_LIST) > 0 then 'P'
        			end as TRGET
        	from CYL_KAIT_TRUBL_MDAT_MST A
        	left outer join (
        		select
        			TRUBL_MDAT_NO ,
        			GROUP_CONCAT(BSNM.BIZRNO separator ',') as P_BIZRNO_LIST ,
        			GROUP_CONCAT(BSNM.BSNM_NM separator ',') as P_BSNM_NM_LIST
        		from
        			CYL_KAIT_ADD_APPLCNT_INFO AINFO
        		inner join CYL_KAIT_BSNM BSNM on
        			BSNM.BSNM_CD = AINFO.BSNM_CD
        		group by
        			TRUBL_MDAT_NO) ADA on
        		A.TRUBL_MDAT_NO = ADA.TRUBL_MDAT_NO
        		where
        		(
        			(
        				A.CI = #{login_user_ci}
        				or A.P_CI = #{login_user_ci}
        				or D_CI = #{login_user_ci}
        				or P_D_CI = #{login_user_ci}
        			)
        			or FIND_IN_SET((select BIZRNO from CYL_KAIT_BSNM_MNG where CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) = #{cttpc}), ADA.P_BIZRNO_LIST) > 0
                    or FIND_IN_SET((SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE P_CI = #{login_user_ci}),ADA.P_BIZRNO_LIST) > 0
        		)
                AND CASE WHEN A.P_D_CI = #{login_user_ci} THEN <![CDATA[A.STTUS <> 'TM001']]>
                          WHEN A.P_CI = #{login_user_ci} THEN <![CDATA[A.STTUS <> 'TM001']]>
                          WHEN FIND_IN_SET(A.BIZRNO, (SELECT BIZRNO FROM CYL_KAIT_BSNM_MNG WHERE CONCAT(CTTPC_F, CTTPC_M, CTTPC_L) = #{cttpc})) > 0 THEN <![CDATA[A.STTUS <> 'TM001']]>
                          ELSE 1 = 1
                END
            LIMIT 0 , 1;
    </select>

    <!--[통신분쟁]2021-08-30 / Kait-42,Kait-69 / by ihpark / 파일 이력관리 및 7일 이내 등록시 new 표시-->
    <update id="viewYnUpdate" parameterType="paramMap">
        UPDATE CYL_KAIT_FILE_HIST A
            SET A.APPLICANT_VIEWYN ='Y'
        WHERE A.TRUBL_MDAT_NO = #{trubl_mdat_no}
          AND NOW() <![CDATA[>=]]> A.CRTE_DTTM;
    </update>
	
	<!--[통신분쟁]2022-06-09 / teka / 사건추가 ( 특정인 로그인시 대리 신청건 검색 ) -->
    <update id="addTrubl" parameterType="paramMap">
        UPDATE CYL_KAIT_TRUBL_MDAT_MST A
            SET CI = #{login_user_ci}
               ,TRUBL_KEY_DT = NOW()
        WHERE REPLACE(NM,' ','') = REPLACE(#{nm},' ','')
          AND BRTHDY = #{birthDate}
          AND TRUBL_KEY = #{key}
          AND CI IS NULL;
    </update>
	
	<!--[통신분쟁]2022-11-01 / hayn /  최초열람일시 관련-->
	 <update id="mdatbFEReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_MDAT_BFE_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_MDAT_BFE_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_MDAT_BFE_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_MDAT_BFE_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>
	
	<!--[통신분쟁]2022-11-01 / hayn /  최초열람일시 관련-->
	<update id="mdatAgrMdatReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_MDATAGR_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_MDATAGR_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_MDATAGR_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_MDATAGR_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>
    <!--[통신분쟁]2022-11-01 / hayn /  최초열람일시 관련-->
    <update id="opinionReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_OPINION_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_OPINION_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_OPINION_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_OPINION_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>
    <!--[통신분쟁]2022-11-01 / hayn /  최초열람일시 관련-->
    <update id="mdat2ReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_MDAT2_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_MDAT2_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_MDAT2_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_MDAT2_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>
    <!--[통신분쟁]2022-11-01 / hayn /  최초열람일시 관련-->
    <update id="enReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_EN_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_EN_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_EN_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_EN_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>

    <update id="octhtMdatReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_OCTHT_MDAT_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_OCTHT_MDAT_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_OCTHT_MDAT_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_OCTHT_MDAT_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>

    <update id="octhtMdatAgrMdatReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_OCTHT_MDATAGR_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_OCTHT_MDATAGR_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_OCTHT_MDATAGR_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_OCTHT_MDATAGR_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>

    <update id="octhtMdat2ReadngDt" parameterType="paramMap">
        <choose>
            <when test="'B'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET B_OCTHT_MDAT2_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND B_OCTHT_MDAT2_READNG_DT IS NULL
            </when>
            <when test="'P'.toString() == trget">
                UPDATE CYL_KAIT_TRUBL_MDAT_MST
                SET P_OCTHT_MDAT2_READNG_DT = NOW()
                WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
                AND P_OCTHT_MDAT2_READNG_DT IS NULL
            </when>
            <otherwise>
            </otherwise>
        </choose>
    </update>

    <select id="findPCttpc" parameterType="map" resultType="paramMap">
        /*통신분쟁 피신청인 전화번호 검색*/
        SELECT COUNT(1) AS CNT
        FROM CYL_KAIT_BSNM_MNG
        WHERE CONCAT(CTTPC_F,CTTPC_M,CTTPC_L) = #{cttpc}
    </select>

    <insert id="saveSignImg" parameterType="map">
        /*통신분쟁 사인 IMG 저장*/
        INSERT INTO
        CYL_CMM_SIGN
        (
            TRUBL_MDAT_NO
            ,TRGET
            ,CALL_REPORT
            ,CI
            ,SIGN_DATA
            ,CRTE_DTTM
        ) VALUES (
            #{trubl_mdat_no}
            ,#{trget}
            ,#{call_report}
            ,#{login_user_ci}
            ,#{sign_data}
            ,SYSDATE()
        ) ON DUPLICATE KEY
        UPDATE CI = #{login_user_ci}
                ,SIGN_DATA = #{sign_data}
                ,UPDT_DTTM = SYSDATE();

        <if test='call_report == "mdatAgr"'>
        /* 조정안 수락서 전자서명 시 조정서에도 전자서명 적용*/
            INSERT IGNORE INTO
            CYL_CMM_SIGN
            (
                TRUBL_MDAT_NO
                ,TRGET
                ,CALL_REPORT
                ,CI
                ,SIGN_DATA
                ,CRTE_DTTM
            ) VALUES (
                #{trubl_mdat_no}
                ,#{trget}
                ,'mdat2'
                ,#{login_user_ci}
                ,#{sign_data}
                ,SYSDATE()
            );
        </if>
    </insert>

    <select id="selectSignImg" parameterType="map" resultType="map">
        SELECT TRUBL_MDAT_NO
                ,TRGET
                ,CALL_REPORT
                ,CI
                ,SIGN_DATA
                ,CRTE_DTTM
                ,UPDT_DTTM
        FROM CYL_CMM_SIGN
        WHERE TRUBL_MDAT_NO = #{TRUBL_MDAT_NO}
        AND TRGET = #{TRGET}
        AND CALL_REPORT = #{CALL_REPORT}
    </select>

    <update id="rqestCancelCn" parameterType="paramMap">
        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET RQEST_CANCEL_CN = #{rqest_cancel_cn}
            ,RQEST_CANCEL_DT = #{rqest_cancel_dt}
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
    </update>

    <update id="mdatBfeCncrrncCn" parameterType="paramMap">
		UPDATE CYL_KAIT_TRUBL_MDAT_MST
		   SET MDAT_BFE_CNCRRNC_CN = #{mdat_bfe_cncrrnc_cn}
		   	   ,CNCRRNC_FORMATN_DT = #{cncrrnc_formatn_dt}
		 WHERE TRUBL_MDAT_NO = #{trubl_mdat_no};

		 CALL P_SMS_MULTI_INSERT4(
			#{trubl_mdat_no}
    	 	,CONCAT('사건번호:', #{trubl_mdat_no}, ', 조정전합의서가 등록 되었습니다. 확인하시고 동의 여부를 체크하여 주시기 바랍니다. 자세한 사항은 www.tdrc.kr > "나의 사건 조회" 화면 하단 ''조정서류'' 에서 확인하실 수 있습니다.')
    	);

    </update>

    <update id="opinionCn" parameterType="paramMap">
        UPDATE CYL_KAIT_TRUBL_MDAT_MST
        SET OPINION_CN = #{opinion_cn}
            ,OPINION_DT = #{opinion_dt}
        WHERE TRUBL_MDAT_NO = #{trubl_mdat_no}
    </update>
</mapper>