<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ApplyDlbrt">
    <!--
        ※ 대메뉴 : 심의
        ※ 중메뉴 : 심의신청
    -->
    <sql id="search">
        <if test="cond_biz_se != null and cond_biz_se != ''">
            AND BIZ_SE = #{cond_biz_se}
        </if>
        <if test="cond_dlbr_sttus != null and cond_dlbr_sttus != ''">
            AND DLBR_STTUS = #{cond_dlbr_sttus}
        </if>
        <if test="cond_crtr_yr != null and cond_crtr_yr != ''">
            AND CRTR_YR = #{cond_crtr_yr}
        </if>
        <if test="cond_dlbr_no != null and cond_dlbr_no != ''">
            AND INSTR(DLBR_NO,#{cond_dlbr_no}) > 0
        </if>
        <if test="cond_biz_nm != null and cond_biz_nm != ''">
            AND INSTR(BIZ_NM,#{cond_biz_nm}) > 0
        </if>
        <if test="cond_task_nm_kr != null and cond_task_nm_kr != ''">
            AND INSTR(TASK_NM_KR,#{cond_task_nm_kr}) > 0
        </if>
    </sql>

    <select id="list" parameterType="paramMap" resultType="paramMap">
        /* ApplyDlbrt.list : 심의>심의신청 목록 */
        <include refid="CylCmm.prefixPagination" />
        SELECT DLBR_NO		/*심의신청번호*/
        , BIZ_SE		/*과제구분(사업구분)*/
        , BIZ_NM		/*사업명*/
        , TASK_NM_KR	/*과제명(국문)*/
        , DLBR_STTUS
        , CASE WHEN DLBR_STTUS = 'DLB01' AND TAB_STEP != '3' THEN '작성중'
        WHEN DLBR_STTUS = 'DLB01' AND TAB_STEP = '3' THEN '미제출'
        WHEN DLBR_STTUS = 'DLB02' THEN '제출'
        ELSE F_COMM_CODE_NM('CYL003',DLBR_STTUS) END AS DLBR_STTUS_NM /*심의신청상태*/
        , CRTR_YR 		/*기준년도*/
        , RSRCH_RSPRS	/*연구책임자*/
        , FRST_REG_USR AS DLBR_APLYR	/*심의신청자*/
        , FRST_REG_DT AS DLBR_DT		/*심의신청일*/
        , TAB_STEP
        , NEXT_CNTTRGT
        , COUNT(*) OVER() AS TOT
        FROM CYL_CMM_DLBR_APLY A
        WHERE DLBR_STTUS IN ('DLB01','DLB02','DLB11','DLB17')
        <!--		<if test='menu_auth != "M"'>-->
        <!--			AND ( (FRST_REG_USR = #{login_user_loginId} OR NEXT_CNTTRGT = #{login_user_loginId} OR RSRCH_RSPRS = #{login_user_loginId})-->
        <!--					OR ( EXISTS (SELECT 'X' FROM CYL_CMM_PRTCP_RSRCHR B WHERE B.RSRCHR_ID = #{login_user_loginId}-->
        <!--																		  AND A.DLBR_NO = B.DLBR_NO) ) )-->
        <!--		</if>-->
        <include refid="ApplyDlbrt.search"/>
        ORDER BY FRST_REG_DT DESC
        <include refid="CylCmm.suffixPagination" />
    </select>

    <select id="view" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view : 심의>심의신청 상세 기본정보 */
		SELECT DLBR_NO		/*심의신청번호*/
		    , TASK_NM_KR	/*과제명(국문)*/
			, BIZ_SE		/*과제구분(사업구분)*/
			, BIZ_SE AS BIZ_SE_SELECT		/*과제구분(사업구분)*/
		    , MULTI_YR_YN	/*다년차여부(다년차:Y, 단년차:N)*/
			, CRTR_YR 		/*기준년도*/
			, DLBR_STTUS	/*심의신청상태*/
			, CASE WHEN DLBR_STTUS = 'DLB01' AND TAB_STEP != '4' THEN '작성중'
				   WHEN DLBR_STTUS = 'DLB01' AND TAB_STEP = '4' THEN '미제출'
				   ELSE F_COMM_CODE_NM('CYL003',DLBR_STTUS) END AS DLBR_STTUS_NM /*심의신청상태*/
			, FRST_REG_USR AS DLBR_APLYR	/*심의신청자*/
			, NEXT_CNTTRGT					/*실무담당자*/
			, RSRCH_RSPRS					/*연구책임자*/
			, FRST_REG_DT AS DLBR_DT		/*심의신청일*/
			, TAB_STEP
		FROM CYL_CMM_DLBR_APLY
		WHERE DLBR_NO = #{dlbr_no}
	</select>

    <select id="view_tab01" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view_tab01 : 심의>심의신청 상세 - 연구계획서 발의 및 승인처리전 */
		SELECT DLBR_NO					/*심의신청번호*/
		    , BIZ_SE					/*과제구분(사업구분)*/
			, BIZ_NM					/*사업명*/
		    , CRTR_YR					/*기준년도*/
		    , TASK_NM_KR				/*과제명(국문)*/
		    , TASK_NM_EN				/*과제명(영문)*/
		    , MULTI_YR_YN				/*다년차여부*/
		    , FORMAT(TOT_WRCS,0) AS TOT_WRCS					/*총사업비*/
		    , BIZ_BGNG_YMD				/*전체사업시작일*/
			, BIZ_END_YMD				/*전체사업종료일*/
			, FORMAT(RSRCH_BUDGET,0) AS RSRCH_BUDGET				/*연구비*/
			, RSRCH_BGNG_YMD				/*연구시작일*/
			, RSRCH_END_YMD				/*연구종료일*/
			, CNSGNOR_NM				/*위탁자명칭*/
			, DSCSS_CHARGER				/*협의담당자*/
			, CNSGNOR_ADR				/*위탁자주소*/
			, CNSGNOR_TELNO				/*위탁자전화번호*/
		    , CNSGNOR_FAX				/*위탁자FAX*/
		    , RSRCH_UPR_DEPT_CD			/*상위연구부서코드*/
			, RSRCH_DEPT_CD				/*연구부서코드*/
			, CONCAT(F_COMM_CODE_DEP_NM(RSRCH_UPR_DEPT_CD),' ', F_COMM_CODE_DEP_NM(RSRCH_DEPT_CD)) as RSRCH_DEPT	/*부서*/
		    , RSRCH_RSPRS				/*연구책임자 ID*/
			, F_COMM_USER_NM(RSRCH_RSPRS) AS RSRCH_RSPRS_NM		/*연구책임자*/
			, RSRCH_RSPRS_TELNO			/*연구책임자 전화*/
		    , NEXT_CNTTRGT				/*차순연락자 ID*/
			, F_COMM_USER_NM(NEXT_CNTTRGT) AS NEXT_CNTTRGT_NM	/*차순연락자*/
			, NEXT_CNTTRGT_TELNO 		/*차순연락자 전화*/
			, SECRET_SE					/*비밀구분*/
			, RSRCH_GOAL				/*연구목표*/
			, RSRCH_EVL_AIM				/*연구평가의 착안점*/
			, RELATE_RSRCH_BIZ_SE		/*관련연구 사업구분*/
			, RELATE_RSRCH_TASK_NM		/*관련연구 과제명*/
			, RELATE_RSRCH_CNSGNOR		/*관련연구 위탁자*/
			, RELATE_RSRCH_BGNG_YMD		/*관련연구 시작일*/
			, RELATE_RSRCH_END_YMD		/*관련연구 종료일*/
			, RELATE_RSRCH_DPCN_YN		/*관련연구 중복여부*/
			, LEGACY_PATENT_STTUS		/*기존 특허 현황*/
			, PATENT_ACQS_POSBLTY		/*특허 취득 가능성*/
			, LEGACY_PATENT_RELTN		/*기존 특허와의 관련성*/
			, ADIT_DEMAND_YN			/*추가요구사항 존재여부*/
			, ADIT_DEMAND_CN			/*추가요구사항 내용*/
			, CTRT_DSCSS_ATENT			/*계약 협의시 유의사항*/
			, FRST_REG_USR				/*신청자*/
		FROM CYL_CMM_DLBR_APLY
		WHERE DLBR_NO = #{dlbr_no}
	</select>

    <select id="view_tab01_popup" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view_tab01_popup : 심의>심의신청 상세 - 연구계획서 조회 */
		SELECT DLBR_NO					/*심의신청번호*/
		    , BIZ_SE					/*과제구분(사업구분)*/
			, BIZ_NM					/*사업명*/
		    , CRTR_YR					/*기준년도*/
		    , TASK_NM_KR				/*과제명(국문)*/
			, FORMAT(RSRCH_BUDGET,0) AS RSRCH_BUDGET				/*연구비*/
			, DATE_FORMAT(RSRCH_BGNG_YMD,'%Y-%m-%d') AS RSRCH_BGNG_YMD				/*연구시작일*/
			, DATE_FORMAT(RSRCH_END_YMD,'%Y-%m-%d') AS RSRCH_END_YMD				/*연구종료일*/
		FROM CYL_CMM_DLBR_APLY
		WHERE DLBR_NO = #{dlbr_no}
	</select>

    <select id="view_tab01_2" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view_tab01_2 : 심의>심의신청 상세 - 연구계획서 발의 및 승인처리전 - 국립해양생물자원관의 타연구부, 타연구원 및 민간부문과의 중복여부 */
		SELECT DPCN_NO
		     , EXC_INST
			 , SIML_EXC_STTUS
		     , DPCN_YN
		FROM CYL_CMM_DLBR_APLY_DPCN
		WHERE DLBR_NO = #{dlbr_no}
		  AND SE = #{se}
		ORDER BY DPCN_NO ASC
	</select>

    <select id="view_tab02" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view_tab02 : 심의>심의신청 상세 - 참여연구원 연구과제 참여 현황 */
		SELECT A.RSRCHR_ID		/*참여연구원 아이디*/
		  	 , F_COMM_USER_NM(RSRCHR_ID) AS RSRCHR_NM	/*사용자명*/
			 , B.INSTT_NM		/*소속*/
			 , B.CLSF			/*직급*/
			 , B.OFFM_TELNO		/*내선번호*/
			 , A.ROLE			/*역할*/
			 , DATE_FORMAT(A.RSRCH_BGNG_YMD,'%Y-%m-%d') AS RSRCH_BGNG_YMD		/*연구시작일*/
			 , DATE_FORMAT(A.RSRCH_END_YMD,'%Y-%m-%d') AS RSRCH_END_YMD			/*연구종료일*/
			 , A.PARTCP_PRD		/*참여기간(개월)*/
			 , A.PARTCP_RATE	/*참여율*/
			 , A.FRST_REG_USR		/*신청자*/
		FROM CYL_CMM_PRTCP_RSRCHR A
		INNER JOIN CYL_CMM_0100_TN B
				ON A.RSRCHR_ID = B.LOGIN_ID
		WHERE A.DLBR_NO = #{dlbr_no}
	</select>

    <select id="view_tab03_01" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view_tab03_01 : 심의>심의신청 상세 - 신규과제 심의요청을 위한 사전 체크리스트 : 기본정보 */
		SELECT A.DLBR_NO
			 , A.CHK_LIST_NO
			 , B.TASK_NM_KR
			 , B.RSRCH_RSPRS AS RSRCH_RSPRS_ID
			 , F_COMM_USER_NM(RSRCH_RSPRS) AS RSRCH_RSPRS
			 , A.TOT_RSRCH_PRD
			 , FORMAT(A.TOT_RSRCCT,0) AS TOT_RSRCCT
			 , FORMAT(A.INST_TOT_RSRCCT,0) AS INST_TOT_RSRCCT
			 , B.FRST_REG_USR		/*신청자*/
		FROM CYL_CMM_DLBR_APLY_CHKLST_RSLT A
		INNER JOIN CYL_CMM_DLBR_APLY B
				ON A.DLBR_NO = B.DLBR_NO
		WHERE A.DLBR_NO = #{dlbr_no}
	</select>

    <select id="view_tab03_02" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view_tab03_02 : 심의>심의신청 상세 - 신규과제 심의요청을 위한 사전 체크리스트 : 검토결과 */
		SELECT CHK_LIST_NO	/*체크리스트번호*/
			 , IEM_NO			/*항목번호*/
			 , IEM_CN			/*항목내용*/
			 , MAIN_NO		/*주요내용번호*/
			 , MAIN_CN		/*주요내용*/
			 , RVW_RSLT		/*검토결과*/
		FROM CYL_CMM_DLBR_APLY_CHKLST_RVWRSLT
		WHERE DLBR_NO = #{dlbr_no}
		ORDER BY IEM_NO ASC, MAIN_NO ASC
	</select>

    <select id="chk_tab03" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.chk_tab03 : 심의>심의신청 상세 - 신규과제 심의요청을 위한 사전 체크리스트 : 작성여부 */
		SELECT COUNT(*) AS CNT FROM CYL_CMM_DLBR_APLY_CHKLST_RSLT
		WHERE DLBR_NO = #{dlbr_no}
	</select>

    <select id="view_tab03_02_new" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.view_tab03_02_new : 심의>심의신청 등록 - 신규과제 심의요청을 위한 사전 체크리스트 : 검토항목 */
		SELECT IEM_NO	/*항목번호*/
			 , IEM_CN	/*항목내용*/
			 , MAIN_NO	/*주요내용번호*/
			 , MAIN_CN	/*주요내용*/
		FROM CYL_CMM_DLBR_APLY_CHKLST_IEM
		ORDER BY IEM_NO ASC, MAIN_NO ASC
	</select>

    <select id="getDept" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.getDept : 심의>심의신청 등록/수정 - 하위부서 조회 */
		SELECT CODE_NM AS RSRCH_DEPT_NM
			 , CODE AS RSRCH_DEPT_CD
		FROM CYL_CMM_0002_TC
		WHERE CODE_ID = #{rsrch_upr_dept_cd}
	</select>

    <select id="get_sttus" parameterType="paramMap" resultType="paramMap">
		/*ApplyDlbrt.get_sttus : 심의>심의신청 - 단계,상태 조회*/
		SELECT DLBR_STTUS, SAVE_YN_TABC01, SAVE_YN_TABC02, SAVE_YN_TABC03, SAVE_YN_TABC04
		FROM CYL_CMM_DLBR_APLY
		WHERE DLBR_NO = #{dlbr_no}
	</select>

    <update id="update_sttus" parameterType="paramMap">
		/*ApplyDlbrt.update_sttus : 심의>심의신청 - 신청서 제출*/
		UPDATE CYL_CMM_DLBR_APLY
		SET DLBR_STTUS = 'DLB02'
		WHERE DLBR_NO = #{dlbr_no}
	</update>

    <insert id="insert_tab01" parameterType="paramMap">
        /*ApplyDlbrt.insert_tab01 : 심의>심의신청 - 심의신청 저장(연구계획서 발의 및 승인처리전)*/
        <selectKey order="BEFORE" keyProperty="selectKey" resultType="String">
            SELECT CONCAT('DLB_',LPAD(IFNULL(MAX(REPLACE(DLBR_NO,'DLB_','')),0)+1,16,0)) FROM CYL_CMM_DLBR_APLY;
        </selectKey>

        INSERT INTO CYL_CMM_DLBR_APLY (
        DLBR_NO
        , BIZ_SE
        , BIZ_NM						/*사업명*/
        , MULTI_YR_YN
        , CRTR_YR
        , TASK_NM_KR
        , TASK_NM_EN
        , TOT_WRCS					/*총사업비*/
        , BIZ_BGNG_YMD				/*전체사업시작일*/
        , BIZ_END_YMD				/*전체사업종료일*/
        , RSRCH_BUDGET
        , RSRCH_BGNG_YMD
        , RSRCH_END_YMD
        , CNSGNOR_NM
        , CNSGNOR_ADR
        , CNSGNOR_TELNO
        , CNSGNOR_FAX
        , DSCSS_CHARGER
        , RSRCH_DEPT_CD
        , RSRCH_UPR_DEPT_CD
        , RSRCH_RSPRS
        , RSRCH_RSPRS_TELNO
        , NEXT_CNTTRGT
        , NEXT_CNTTRGT_TELNO
        , SECRET_SE
        , RSRCH_GOAL
        , RSRCH_EVL_AIM
        , RELATE_RSRCH_BIZ_SE
        , RELATE_RSRCH_TASK_NM
        , RELATE_RSRCH_CNSGNOR
        , RELATE_RSRCH_BGNG_YMD
        , RELATE_RSRCH_END_YMD
        , RELATE_RSRCH_DPCN_YN
        , LEGACY_PATENT_STTUS
        , PATENT_ACQS_POSBLTY
        , LEGACY_PATENT_RELTN
        , ADIT_DEMAND_YN
        , ADIT_DEMAND_CN
        , CTRT_DSCSS_ATENT
        , DLBR_STTUS
        , FRST_REG_USR
        , FRST_REG_DT
        , TAB_STEP
        , SAVE_YN_TABC01
        ) VALUES (
        #{selectKey}					/*심의신청번호*/
        , #{biz_se}						/*사업구분*/
        , #{biz_nm}						/*사업명*/
        , <choose>
        <when test="multi_yr_yn != null and multi_yr_yn != ''">
            #{multi_yr_yn}					/*다년차여부(다년차:Y, 단년차:N)*/
        </when>
        <otherwise>'N'</otherwise>
    </choose>
        , #{crtr_yr}					/*기준년도*/
        , #{task_nm_kr}					/*과제명 국문*/
        , #{task_nm_en}					/*과제명 영문*/
        , <choose>
        <when test="tot_wrcs != null and tot_wrcs != ''">
            REPLACE(#{tot_wrcs},',','')	/*총사업비*/
        </when>
        <when test='multi_yr_yn == "N"'>
            REPLACE(#{rsrch_budget},',','')
        </when>
        <otherwise>NULL</otherwise>
    </choose>
        , <choose>
        <when test="biz_bgng_ymd != null and biz_bgng_ymd != ''">
            #{biz_bgng_ymd}            	/*전체사업시작일*/
        </when>
        <when test='multi_yr_yn == "N"'>
            #{rsrch_bgng_ymd}
        </when>
        <otherwise>NULL</otherwise>
    </choose>
        , <choose>
        <when test="biz_end_ymd != null and biz_end_ymd != ''">
            #{biz_end_ymd}             	/*전체사업종료일*/
        </when>
        <when test='multi_yr_yn == "N"'>
            #{rsrch_end_ymd}
        </when>
        <otherwise>NULL</otherwise>
    </choose>
        , REPLACE(#{rsrch_budget},',','')	/*연구비*/
        , #{rsrch_bgng_ymd}				/*연구시작일*/
        , #{rsrch_end_ymd}				/*연구종료일*/
        , #{cnsgnor_nm}					/*위탁자명칭*/
        , #{cnsgnor_adr}				/*위탁자주소*/
        , #{cnsgnor_telno}				/*위탁자전화*/
        , #{cnsgnor_fax}				/*위탁자FAX*/
        , #{dscss_charger}				/*협의담당자*/
        , #{rsrch_dept_cd}				/*연구부서코드*/
        , #{rsrch_upr_dept_cd}			/*연구부서 상위부서코드*/
        , #{rsrch_rsprs}				/*연구책임자*/
        , #{rsrch_rsprs_telno}			/*연구책임자 전화*/
        , #{next_cnttrgt}				/*차순연락자*/
        , #{next_cnttrgt_telno}			/*차순연락자전화*/
        , #{secret_se}					/*비밀구분*/
        , #{rsrch_goal}					/*연구목표*/
        , #{rsrch_evl_aim}				/*연구평가의착안점*/
        , #{relate_rsrch_biz_se}		/*관련연구 사업구분*/
        , #{relate_rsrch_task_nm}		/*관련연구 과제명*/
        , #{relate_rsrch_cnsgnor}		/*관련연구 위탁자*/
        , #{relate_rsrch_bgng_ymd}		/*관련연구 시작일*/
        , #{relate_rsrch_end_ymd}		/*관련연구 종료일*/
        , #{relate_rsrch_dpcn_yn}		/*관련연구 중복여부*/
        , #{legacy_patent_sttus}		/*기존 특허 현황*/
        , #{patent_acqs_posblty}		/*특허 취득 가능성*/
        , #{legacy_patent_reltn}		/*기존 특허와의 관련성*/
        , #{adit_demand_yn}				/*추가요구사항 존재여부*/
        , #{adit_demand_cn}				/*추가요구사항 내용*/
        , #{ctrt_dscss_atent}			/*계약 협의시 유의사항*/
        , #{dlbr_sttus}					/*심의진행상태(입력:DLB01, 제출:DLB02, 수정보완요청:DLB03, 수정보완:DLB04, 심의신청반려:DLB05, 심의진행:DLB06, 가결:DLB07, 부결:DLB08)*/
        , #{login_user_loginId}			/*최초등록자(심의신청자)*/
        , NOW()							/*최초등록일시(심의신청일시)*/
        , #{tab_step}					/*심의신청 탭 단계*/
        , #{save_yn_tabC01}				/*연구계획서 발의 및 승인처리전 작성여부(tabC01)*/
        );

        DELETE FROM CYL_CMM_DLBR_APLY_DPCN
        WHERE DLBR_NO = #{selectKey};
        <if test="dpcn_list != null and dpcn_list != ''">
            <foreach separator="" item="vo" index="i" collection="dpcn_list">
                INSERT INTO CYL_CMM_DLBR_APLY_DPCN
                (
                DLBR_NO
                , SE
                , DPCN_NO
                , EXC_INST
                , SIML_EXC_STTUS
                , DPCN_YN
                , FRST_REG_USR
                , FRST_REG_DT
                ) VALUES (
                #{selectKey}
                , #{vo.se}
                , #{vo.dpcn_no}
                , #{vo.exc_inst}
                , #{vo.siml_exc_sttus}
                , #{vo.dpcn_yn}
                , #{login_user_loginId}
                , NOW()
                );
            </foreach>
        </if>
    </insert>

    <update id="update_tab01" parameterType="paramMap">
        /*ApplyDlbrt.update_tab01 : 심의>심의신청 - 심의신청 수정(연구계획서 발의 및 승인처리전)*/
        UPDATE CYL_CMM_DLBR_APLY
        SET BIZ_SE = #{biz_se}								/*사업구분*/
        , BIZ_NM = #{biz_nm}
        , MULTI_YR_YN =
        <choose>
            <when test="multi_yr_yn != null and multi_yr_yn != ''">
                #{multi_yr_yn}					/*다년차여부(다년차:Y, 단년차:N)*/
            </when>
            <otherwise>'N'</otherwise>
        </choose>
        , CRTR_YR = #{crtr_yr}							/*기준년도*/
        , TASK_NM_KR = #{task_nm_kr}						/*과제명 국문*/
        , TASK_NM_EN = #{task_nm_en}						/*과제명 영문*/
        , TOT_WRCS =
        <choose>
            <when test="tot_wrcs != null and tot_wrcs != ''">
                REPLACE(#{tot_wrcs},',','')			/*총사업비*/
            </when>
            <otherwise>NULL</otherwise>
        </choose>
        , BIZ_BGNG_YMD =
        <choose>
            <when test="biz_bgng_ymd != null and biz_bgng_ymd != ''">
                #{biz_bgng_ymd}					/*전체사업시작일*/
            </when>
            <otherwise>NULL</otherwise>
        </choose>
        , BIZ_END_YMD =
        <choose>
            <when test="biz_end_ymd != null and biz_end_ymd != ''">
                #{biz_end_ymd}					/*전체사업종료일*/
            </when>
            <otherwise>NULL</otherwise>
        </choose>
        , RSRCH_BUDGET = REPLACE(#{rsrch_budget},',','')	/*연구비*/
        , RSRCH_BGNG_YMD = #{rsrch_bgng_ymd}				/*연구시작일*/
        , RSRCH_END_YMD = #{rsrch_end_ymd}				/*연구종료일*/
        , CNSGNOR_NM = #{cnsgnor_nm}						/*위탁자명칭*/
        , CNSGNOR_ADR = #{cnsgnor_adr}					/*위탁자주소*/
        , CNSGNOR_TELNO = #{cnsgnor_telno}				/*위탁자전화*/
        , CNSGNOR_FAX = #{cnsgnor_fax}					/*위탁자FAX*/
        , DSCSS_CHARGER = #{dscss_charger}				/*협의담당자*/
        , RSRCH_DEPT_CD = #{rsrch_dept_cd}				/*연구부서코드*/
        , RSRCH_UPR_DEPT_CD = #{rsrch_upr_dept_cd}		/*연구부서 상위부서코드*/
        , RSRCH_RSPRS = #{rsrch_rsprs}					/*연구책임자*/
        , RSRCH_RSPRS_TELNO = #{rsrch_rsprs_telno}		/*연구책임자 전화*/
        , NEXT_CNTTRGT = #{next_cnttrgt}					/*차순연락자*/
        , NEXT_CNTTRGT_TELNO = #{next_cnttrgt_telno}		/*차순연락자전화*/
        , SECRET_SE = #{secret_se}						/*비밀구분*/
        , RSRCH_GOAL = #{rsrch_goal}						/*연구목표*/
        , RSRCH_EVL_AIM = #{rsrch_evl_aim}				/*연구평가의착안점*/
        , RELATE_RSRCH_BIZ_SE = #{relate_rsrch_biz_se}		/*관련연구 사업구분*/
        , RELATE_RSRCH_TASK_NM = #{relate_rsrch_task_nm}		/*관련연구 과제명*/
        , RELATE_RSRCH_CNSGNOR = #{relate_rsrch_cnsgnor}		/*관련연구 위탁자*/
        , RELATE_RSRCH_BGNG_YMD = #{relate_rsrch_bgng_ymd}	/*관련연구 시작일*/
        , RELATE_RSRCH_END_YMD = #{relate_rsrch_end_ymd}		/*관련연구 종료일*/
        , RELATE_RSRCH_DPCN_YN = #{relate_rsrch_dpcn_yn}		/*관련연구 중복여부*/
        , LEGACY_PATENT_STTUS = #{legacy_patent_sttus}	/*기존 특허 현황*/
        , PATENT_ACQS_POSBLTY = #{patent_acqs_posblty}	/*특허 취득 가능성*/
        , LEGACY_PATENT_RELTN = #{legacy_patent_reltn}	/*기존 특허와의 관련성*/
        , ADIT_DEMAND_YN = #{adit_demand_yn}				/*추가요구사항 존재여부*/
        , ADIT_DEMAND_CN = #{adit_demand_cn}				/*추가요구사항 내용*/
        , CTRT_DSCSS_ATENT = #{ctrt_dscss_atent}			/*계약 협의시 유의사항*/
        , TAB_STEP = #{tab_step}
        , SAVE_YN_TABC01 = #{save_yn_tabC01}				/*연구계획서 발의 및 승인처리전 작성여부(tabC01)*/
        , LAST_MDFCN_USR = #{login_user_loginId}			/*최초등록자(심의신청자)*/
        , LAST_MDFCN_DT = NOW()							/*최초등록일시(심의신청일시)*/
        , DLBR_STTUS = #{dlbr_sttus}						/*심의신청진행상태*/
        WHERE DLBR_NO = #{dlbr_no}
        AND DLBR_STTUS IN ('DLB01','DLB03');


        DELETE FROM CYL_CMM_DLBR_APLY_DPCN
        WHERE DLBR_NO = #{dlbr_no};
        <if test="dpcn_list != null and dpcn_list != ''">
            <foreach separator="" item="vo" index="i" collection="dpcn_list">
                INSERT INTO CYL_CMM_DLBR_APLY_DPCN
                (
                DLBR_NO
                , SE
                , DPCN_NO
                , EXC_INST
                , SIML_EXC_STTUS
                , DPCN_YN
                , FRST_REG_USR
                , FRST_REG_DT
                ) VALUES (
                #{dlbr_no}
                , #{vo.se}
                , #{vo.dpcn_no}
                , #{vo.exc_inst}
                , #{vo.siml_exc_sttus}
                , #{vo.dpcn_yn}
                , #{login_user_loginId}
                , NOW()
                );
            </foreach>
        </if>
    </update>

    <select id="chk_before_insert_tab02" parameterType="paramMap" resultType="paramMap">
		/*ApplyDlbrt.chk_before_insert_tab02 : 심의>심의신청 - 참여연구원 연구과제 참여 현황 존재여부 체크*/
		SELECT COUNT(*) AS CNT
		FROM CYL_CMM_PRTCP_RSRCHR
		WHERE DLBR_NO = #{dlbr_no}
		  AND STEP= '01'
	</select>

    <update id="insert_tab02" parameterType="paramMap">
        /*ApplyDlbrt.insert_tab02 : 심의>심의신청 - 심의신청 저장(참여연구원 연구과제 참여 현황)*/
        <if test="partcp_list != null and partcp_list != ''">
            <foreach separator="" item="vo" index="i" collection="partcp_list">
                INSERT INTO CYL_CMM_PRTCP_RSRCHR
                (
                RSRCHR_ID
                , DLBR_NO
                , STEP
                , ROLE
                , RSRCH_BGNG_YMD
                , RSRCH_END_YMD
                , PARTCP_PRD
                , PARTCP_RATE
                , FRST_REG_USR
                , FRST_REG_DT
                ) VALUES (
                #{vo.rsrchr_id}
                , #{vo.dlbr_no}
                , '01'
                , #{vo.role}
                , #{vo.rsrch_bgng_ymd}
                , #{vo.rsrch_end_ymd}
                , #{vo.partcp_prd}
                , #{vo.partcp_rate}
                , (SELECT FRST_REG_USR FROM CYL_CMM_DLBR_APLY aply WHERE DLBR_NO = #{vo.dlbr_no})
                , NOW()
                );
            </foreach>
        </if>

        UPDATE CYL_CMM_DLBR_APLY
        SET   TAB_STEP = #{tab_step}
        , SAVE_YN_TABC02 = #{save_yn_tabC02}
        , DLBR_STTUS = #{dlbr_sttus}						/*심의신청진행상태*/
        WHERE DLBR_NO = #{dlbr_no};
    </update>

    <delete id="delete_tab02" parameterType="paramMap">
		/*ApplyDlbrt.delete_tab02 : 심의>심의신청 - 심의신청 저장(참여연구원 연구과제 참여 현황 삭제)*/
		DELETE FROM CYL_CMM_PRTCP_RSRCHR
		WHERE DLBR_NO = #{dlbr_no}
		  AND STEP = '01';
	</delete>

    <insert id="rsrchr_rgstr" parameterType="paramMap">
		/* ApplyDlbrt.rsrchr_rgstr : 심의>심의신청 : 참여연구원 개별 등록 */
		DELETE FROM CYL_CMM_PRTCP_RSRCHR
		WHERE DLBR_NO = #{dlbr_no}
		AND RSRCHR_ID = #{rsrchr_id};

		INSERT INTO
			CYL_CMM_PRTCP_RSRCHR (
				DLBR_NO
				,RSRCHR_ID
				,ROLE
				,RSRCH_BGNG_YMD
				,RSRCH_END_YMD
				,PARTCP_RATE
				,STEP
			) VALUES (
				#{dlbr_no}
				,#{rsrchr_id}
				,#{role}
				,#{rsrch_bgng_ymd}
				,#{rsrch_end_ymd}
				,#{partcp_rate}
				,'01'
			);
	</insert>

    <select id="get_tot_rsrch_prd" parameterType="paramMap" resultType="paramMap">
		/*ApplyDlbrt.get_tot_rsrch_prd : 심의>심의신청 - 심의신청 저장(신규과제 심의요청을 위한 사전 체크리스트) - 총 연구기간 및 금액*/
		SELECT TIMESTAMPDIFF(MONTH, RSRCH_BGNG_YMD, RSRCH_END_YMD) AS TOT_RSRCH_PRD
			, CASE WHEN TOT_WRCS IS NULL THEN FORMAT(RSRCH_BUDGET,0)
				   ELSE FORMAT(TOT_WRCS,0) END AS TOT_BUDGET	/*총연구비*/
			, FORMAT(RSRCH_BUDGET,0) AS RSRCH_BUDGET			/*우리관총연구비*/
		FROM CYL_CMM_DLBR_APLY
		WHERE DLBR_NO = #{dlbr_no}
	</select>

    <update id="update_tab03" parameterType="paramMap">
        /*ApplyDlbrt.update_tab03 : 심의>심의신청 - 심의신청 저장(신규과제 심의요청을 위한 사전 체크리스트 수정)*/
        /*1.체크리스트 - 기본정보*/
        UPDATE CYL_CMM_DLBR_APLY_CHKLST_RSLT
        SET TOT_RSRCH_PRD = #{tot_rsrch_prd}
        , TOT_RSRCCT = REPLACE(#{tot_rsrcct},',','')
        , INST_TOT_RSRCCT = REPLACE(#{inst_tot_rsrcct},',','')
        , LAST_MDFCN_USR = #{login_user_loginId}
        , LAST_MDFCN_DT = NOW()
        WHERE DLBR_NO = #{dlbr_no}
        AND CHK_LIST_NO = #{chk_list_no};

        /*2.체크리스트 - 검토결과*/
        <if test="chklist != null and chklist != ''">
            <foreach collection="chklist" index="i" item="vo" separator="">
                UPDATE CYL_CMM_DLBR_APLY_CHKLST_RVWRSLT
                SET IEM_CN = #{vo.iem_cn}
                , MAIN_CN = #{vo.main_cn}
                , RVW_RSLT = #{vo.rvw_rslt}
                , LAST_MDFCN_USR = #{login_user_loginId}
                , LAST_MDFCN_DT = NOW()
                WHERE DLBR_NO = #{dlbr_no}
                AND CHK_LIST_NO = #{chk_list_no}
                AND IEM_NO = #{vo.iem_no}
                AND MAIN_NO = #{vo.main_no};
            </foreach>
        </if>
        UPDATE CYL_CMM_DLBR_APLY
        SET TAB_STEP = #{tab_step}
        , SAVE_YN_TABC03 = #{save_yn_tabC03}
        , DLBR_STTUS = #{dlbr_sttus}						/*심의신청진행상태*/
        WHERE DLBR_NO = #{dlbr_no};
    </update>

    <update id="insert_tab03" parameterType="paramMap">
        /*ApplyDlbrt.insert_tab03 : 심의>심의신청 - 심의신청 저장(신규과제 심의요청을 위한 사전 체크리스트)*/
        <selectKey order="BEFORE" keyProperty="selectKey" resultType="String">
            SELECT CONCAT('CHK_',LPAD(IFNULL(MAX(REPLACE(CHK_LIST_NO,'CHK_','')),'0')+ 1,16,0))
            FROM CYL_CMM_DLBR_APLY_CHKLST_RSLT
            WHERE DLBR_NO = #{dlbr_no};
        </selectKey>
        /*1.체크리스트 - 기본정보*/
        INSERT INTO CYL_CMM_DLBR_APLY_CHKLST_RSLT
        (
        DLBR_NO
        , CHK_LIST_NO
        , TOT_RSRCH_PRD
        , TOT_RSRCCT
        , INST_TOT_RSRCCT
        , FRST_REG_USR
        , FRST_REG_DT
        ) VALUES (
        #{dlbr_no}
        , #{selectKey}
        , #{tot_rsrch_prd}
        , REPLACE(#{tot_rsrcct},',','')
        , REPLACE(#{inst_tot_rsrcct},',','')
        , #{login_user_loginId}
        , NOW()
        );
        /*2.체크리스트 - 검토결과*/
        <if test="chklist != null and chklist != ''">
            <foreach collection="chklist" index="i" item="vo" separator="">
                INSERT INTO CYL_CMM_DLBR_APLY_CHKLST_RVWRSLT
                (
                DLBR_NO
                , CHK_LIST_NO
                , IEM_NO
                , IEM_CN
                , MAIN_NO
                , MAIN_CN
                , RVW_RSLT
                , FRST_REG_USR
                , FRST_REG_DT
                ) VALUES (
                #{dlbr_no}
                , #{selectKey}
                , #{vo.iem_no}
                , #{vo.iem_cn}
                , #{vo.main_no}
                , #{vo.main_cn}
                , #{vo.rvw_rslt}
                , #{login_user_loginId}
                , NOW()
                );
            </foreach>
        </if>

        UPDATE CYL_CMM_DLBR_APLY
        SET TAB_STEP = #{tab_step}
        , SAVE_YN_TABC03 = #{save_yn_tabC03}
        , LAST_MDFCN_USR = #{login_user_loginId}
        , LAST_MDFCN_DT = NOW()
        WHERE DLBR_NO = #{dlbr_no};
    </update>


    <select id="chk_tab04" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.chk_tab04 : 심의>심의신청 - 심의신청 저장(제출서류) 파일유무 체크 */
		SELECT COUNT(*) AS CNT FROM CYL_CMM_FILE_MAPNG
		WHERE MAPNG_TABLE = 'CYL_CMM_DLBR_APLY'
		  AND MAPNG_KEY = #{dlbr_no}
	</select>

    <update id="insert_tab04" parameterType="paramMap">
        /* ApplyDlbrt.insert_tab04 : 심의>심의신청 - 심의신청 저장(제출서류) */
        <if test="attac_multi != null and attac_multi != ''">
            DELETE FROM CYL_CMM_FILE_MAPNG
            WHERE MAPNG_TABLE = #{mapng_table}
            AND MAPNG_KEY = #{dlbr_no}
            AND COLUNM_NM LIKE 'ATTAC_COLNAME%';

            DELETE FROM CYL_CMM_DB_USE_MAPNG
            WHERE MAPNG_TABLE = #{mapng_table}
            AND MAPNG_KEY = #{dlbr_no};

            INSERT INTO
            CYL_CMM_DB_USE_MAPNG(
            MAPNG_KEY
            ,MAPNG_TABLE
            ,USE_YN
            ,CRTE_USER_ID
            ,CRTE_DTTM
            ) VALUES (
            #{dlbr_no}
            ,#{mapng_table}
            ,'Y'
            ,#{login_user_id}
            ,NOW()
            );
            <foreach separator="" item="vo" index="i" collection="attac_multi">
                INSERT INTO CYL_CMM_FILE_MAPNG (
                MAPNG_KEY
                ,MAPNG_TABLE
                ,ATCH_FILE_ID
                ,COLUNM_NM
                ,COLUNM_SN
                ,SN
                ,CRTE_USER_ID
                ,CRTE_DTTM
                ,USE_AT
                ) VALUES (
                #{dlbr_no}
                ,#{mapng_table}
                ,#{vo.atch_file_id}
                ,'ATTAC_COLNAME'
                ,#{vo.colunm_sn}
                ,1
                ,#{login_user_id}
                ,NOW()
                ,'Y'
                );
            </foreach>
        </if>

        UPDATE CYL_CMM_DLBR_APLY
        SET TAB_STEP = #{tab_step}
        , SAVE_YN_TABC04 = #{save_yn_tabC04}
        , LAST_MDFCN_USR = #{login_user_loginId}
        , LAST_MDFCN_DT = NOW()
        , DLBR_STTUS = #{dlbr_sttus}						/*심의신청진행상태*/
        WHERE DLBR_NO = #{dlbr_no};
    </update>



    <update id="update_tab04" parameterType="paramMap">
        /* ApplyDlbrt.update_tab04 : 심의>심의신청 - 심의신청 저장(제출서류) */
        DELETE FROM CYL_CMM_FILE_MAPNG
        WHERE MAPNG_TABLE = #{mapng_table}
        AND MAPNG_KEY = #{dlbr_no}
        AND COLUNM_NM LIKE 'ATTAC_COLNAME%';

        DELETE FROM CYL_CMM_DB_USE_MAPNG
        WHERE MAPNG_TABLE = #{mapng_table}
        AND MAPNG_KEY = #{dlbr_no};

        INSERT INTO
        CYL_CMM_DB_USE_MAPNG(
        MAPNG_KEY
        ,MAPNG_TABLE
        ,USE_YN
        ,CRTE_USER_ID
        ,CRTE_DTTM
        ) VALUES (
        #{dlbr_no}
        ,#{mapng_table}
        ,'Y'
        ,#{login_user_id}
        ,NOW()
        );

        <if test="attac_multi != null and attac_multi != ''">
            <foreach separator="" item="vo" index="i" collection="attac_multi">
                INSERT INTO
                CYL_CMM_FILE_MAPNG (
                MAPNG_KEY
                ,MAPNG_TABLE
                ,ATCH_FILE_ID
                ,COLUNM_NM
                ,COLUNM_SN
                ,SN
                ,CRTE_USER_ID
                ,CRTE_DTTM
                ,USE_AT
                ) VALUES (
                #{dlbr_no}
                , #{mapng_table}
                ,#{vo.atch_file_id}
                ,'ATTAC_COLNAME'
                ,#{vo.colunm_sn}
                ,1
                ,#{login_user_id}
                ,NOW()
                ,'Y'
                );
            </foreach>
        </if>

        UPDATE CYL_CMM_DLBR_APLY
        SET TAB_STEP = #{tab_step}
        , SAVE_YN_TABC04 = #{save_yn_tabC04}
        , DLBR_STTUS = #{dlbr_sttus}						/*심의신청진행상태*/
        WHERE DLBR_NO = #{dlbr_no};
    </update>

    <insert id="insert_aply_hist" parameterType="paramMap">
        /*ApplyDlbrt.insert_aply_hist : 심의>심의신청 - 심의신청이력*/
        <selectKey resultType="String" keyProperty="hist_no" order="BEFORE">
            SELECT IFNULL(MAX(HIST_NO),0) + 1 FROM CYL_CMM_DLBR_APLY_HIST
        </selectKey>
        INSERT INTO CYL_CMM_DLBR_APLY_HIST
        (
        DLBR_NO
        , HIST_NO
        , DLBR_STTUS
        , MDFCN_DEMAND_CN
        , RJCT_RESN
        , HIST_CN
        , FRST_REG_USR
        , FRST_REG_DT
        ) VALUES (
        #{dlbr_no}
        , #{hist_no}
        , #{dlbr_sttus}
        , <choose>
        <when test="mdfcn_demand_cn != null and mdfcn_demand_cn != ''">
            #{mdfcn_demand_cn}
        </when>
        <otherwise>NULL</otherwise>
    </choose>
        , <choose>
        <when test="rjct_resn != null and rjct_resn != ''">
            #{rjct_resn}
        </when>
        <otherwise>NULL</otherwise>
    </choose>
        , <choose>
        <when test="hist_cn != null and hist_cn != ''">
            #{hist_cn}
        </when>
        <otherwise>NULL</otherwise>
    </choose>
        , #{login_user_loginId}
        , NOW()
        )
    </insert>

    <select id="file_list" parameterType="paramMap" resultType="paramMap">
		/* ApplyDlbrt.file_list : 심의>심의신청 - 제출서류 파일리스트 */
		SELECT A.MAPNG_KEY
			,A.COLUNM_NM
			,A.SN
			,A.COLUNM_SN
			,A.ATCH_FILE_ID
			,B.ORGINL_FILE_NM AS ATCH_FILE_ID_NM
			,B.FILE_SIZE
			,(SELECT LOGIN_ID FROM CYL_CMM_0100_TN WHERE USER_ID = A.CRTE_USER_ID) AS FRST_REG_USR
		FROM CYL_CMM_FILE_MAPNG A
		LEFT OUTER JOIN CYL_CMM_0401_TN B
		ON A.ATCH_FILE_ID = B.ATCH_FILE_ID
		AND B.FILE_SN = A.COLUNM_SN
		WHERE A.MAPNG_TABLE = 'CYL_CMM_DLBR_APLY'
		AND A.MAPNG_KEY = #{dlbr_no}
		AND A.USE_AT = 'Y'
		ORDER BY A.MAPNG_KEY DESC,A.ATCH_FILE_ID, A.COLUNM_NM ASC, A.COLUNM_SN ASC
	</select>

    <delete id="delete" parameterType="paramMap">
		/* ApplyDlbrt.delete : 심의>심의신청관리 삭제 */
		DELETE FROM CYL_CMM_DLBR_APLY WHERE DLBR_NO = #{dlbr_no};
		DELETE FROM CYL_CMM_DLBR_APLY_DPCN WHERE DLBR_NO = #{dlbr_no};
		DELETE FROM CYL_CMM_DLBR_APLY_CHKLST_RSLT WHERE DLBR_NO = #{dlbr_no};
		DELETE FROM CYL_CMM_PRTCP_RSRCHR WHERE DLBR_NO = #{dlbr_no};
		DELETE FROM CYL_CMM_DLBR_APLY_HIST WHERE DLBR_NO = #{dlbr_no};

		DELETE FROM CYL_CMM_FILE_MAPNG
		WHERE MAPNG_TABLE = #{mapng_table}
		  AND MAPNG_KEY = #{dlbr_no}
		  AND COLUNM_NM LIKE 'ATTAC_COLNAME%';

		DELETE FROM CYL_CMM_DB_USE_MAPNG
		WHERE MAPNG_TABLE = #{mapng_table}
		  AND MAPNG_KEY = #{dlbr_no};
 	</delete>

</mapper>